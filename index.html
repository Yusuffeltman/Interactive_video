
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>MEd Dissertation Unit â€” From Proposal to Completion</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --cream:#faf8f3;--cream2:#f2ede3;
  --navy:#1a2744;--navy2:#243460;
  --amber:#c97d2e;--amber2:#e8974a;--amber-dim:rgba(201,125,46,0.12);
  --green:#2d7a4f;--green-dim:rgba(45,122,79,0.1);
  --red:#c0392b;--red-dim:rgba(192,57,43,0.1);
  --purple:#6b46c1;--purple-dim:rgba(107,70,193,0.1);
  --text:#1a1a2e;--muted:#6b6b7a;--border:#d4cfc4;
  --radius:10px;--shadow:0 2px 16px rgba(26,39,68,0.10);
}
html,body{height:100%;background:var(--cream);color:var(--text);font-family:'Lora',Georgia,serif;font-size:15px;line-height:1.7;-webkit-font-smoothing:antialiased;}
.shell{display:grid;grid-template-columns:270px 1fr;min-height:100vh;}

/* SIDEBAR */
.sidebar{background:var(--navy);color:#fff;display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow-y:auto;}
.sidebar-header{padding:24px 20px 16px;border-bottom:1px solid rgba(255,255,255,0.08);}
.sidebar-logo{font-size:11px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:5px;font-family:'DM Mono',monospace;}
.sidebar-title{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;color:#fff;line-height:1.3;}
.sidebar-sub{font-size:11px;color:rgba(255,255,255,0.35);margin-top:3px;font-family:'DM Mono',monospace;}
.prog-wrap{padding:14px 20px;border-bottom:1px solid rgba(255,255,255,0.08);}
.prog-label{font-size:10px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;}
.prog-bg{height:3px;background:rgba(255,255,255,0.1);border-radius:4px;}
.prog-fill{height:100%;background:var(--amber2);border-radius:4px;transition:width .5s ease;}
.prog-txt{font-size:10px;color:rgba(255,255,255,0.35);margin-top:4px;font-family:'DM Mono',monospace;}
.nav-list{padding:8px 0;flex:1;}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 20px;cursor:pointer;transition:background .2s;border-left:3px solid transparent;}
.nav-item:hover{background:rgba(255,255,255,0.05);}
.nav-item.active{background:rgba(232,151,74,0.12);border-left-color:var(--amber2);}
.nav-item.done .nav-num{background:var(--green)!important;}
.nav-num{width:22px;height:22px;border-radius:50%;background:rgba(255,255,255,0.1);display:grid;place-items:center;font-size:10px;font-weight:700;flex-shrink:0;font-family:'DM Mono',monospace;transition:background .3s;}
.nav-item.active .nav-num{background:var(--amber2);}
.nav-lbl{font-size:12px;font-weight:500;color:rgba(255,255,255,0.7);line-height:1.3;}
.nav-item.active .nav-lbl{color:#fff;}

/* MAIN */
.main{display:flex;flex-direction:column;min-width:0;}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:14px 36px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:10;}
.unit-badge{background:var(--amber-dim);border:1px solid rgba(201,125,46,0.3);color:var(--amber);border-radius:20px;padding:3px 12px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;font-family:'DM Mono',monospace;}
.unit-title-bar{font-family:'Playfair Display',serif;font-size:16px;font-weight:600;}
.topbar-btns{margin-left:auto;display:flex;gap:8px;}
.content-area{flex:1;padding:36px;max-width:840px;}
.unit-panel{display:none;}
.unit-panel.active{display:block;animation:fadeUp .35s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* TYPOGRAPHY */
h1.mh{font-family:'Playfair Display',serif;font-size:30px;font-weight:700;line-height:1.2;margin-bottom:8px;color:var(--navy);}
h2.sh{font-family:'Playfair Display',serif;font-size:20px;font-weight:600;color:var(--navy);margin:28px 0 10px;padding-bottom:7px;border-bottom:2px solid var(--amber);}
h3.subh{font-size:15px;font-weight:600;color:var(--navy2);margin:16px 0 6px;}
p{margin-bottom:12px;color:#2d2d3a;}
.lead{font-size:17px;color:var(--muted);font-style:italic;margin-bottom:20px;line-height:1.6;}

/* VIDEO PLAYER */
.video-section{background:var(--navy);border-radius:var(--radius);overflow:hidden;margin-bottom:28px;}
.video-label{padding:12px 18px;background:rgba(255,255,255,0.06);border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;gap:8px;}
.video-label-text{font-size:12px;font-weight:600;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:.8px;font-family:'DM Mono',monospace;}
.video-label-title{font-size:13px;color:#fff;font-weight:600;margin-left:auto;}
.video-wrap{position:relative;padding-top:56.25%;}
.video-wrap iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:none;}

/* CARDS */
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:18px;box-shadow:var(--shadow);}
.card-accent{border-left:4px solid var(--amber);}
.info-box{background:rgba(26,39,68,0.04);border:1px solid rgba(26,39,68,0.1);border-left:4px solid var(--navy);border-radius:var(--radius);padding:14px 18px;margin:16px 0;}
.info-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--navy);margin-bottom:5px;}
.tip-box{background:var(--amber-dim);border:1px solid rgba(201,125,46,0.2);border-left:4px solid var(--amber);border-radius:var(--radius);padding:14px 18px;margin:14px 0;}
.tip-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--amber);margin-bottom:5px;}
.warn-box{background:var(--red-dim);border:1px solid rgba(192,57,43,0.2);border-left:4px solid var(--red);border-radius:var(--radius);padding:14px 18px;margin:14px 0;}

/* EXERCISES */
.ex-block{background:#fff;border:2px solid var(--navy);border-radius:var(--radius);padding:22px;margin:20px 0;}
.ex-header{display:flex;align-items:center;gap:9px;margin-bottom:14px;}
.ex-tag{background:var(--navy);color:#fff;border-radius:4px;padding:2px 9px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;font-family:'DM Mono',monospace;}
.ex-title{font-family:'Playfair Display',serif;font-size:16px;font-weight:600;color:var(--navy);}
.ex-hint{font-size:13px;color:var(--muted);font-style:italic;margin-bottom:9px;}
textarea.ex-input{width:100%;min-height:110px;border:1px solid var(--border);border-radius:8px;padding:12px;font-family:'Lora',serif;font-size:14px;line-height:1.6;color:var(--text);background:var(--cream);resize:vertical;transition:border-color .2s;}
textarea.ex-input:focus{outline:none;border-color:var(--amber);background:#fff;}
.ex-lbl{font-size:14px;font-weight:600;margin-bottom:5px;color:var(--navy);}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}

/* BUTTONS */
.btn{border:none;border-radius:8px;padding:10px 20px;font-family:'Lora',serif;font-weight:600;font-size:13px;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:7px;}
.btn:active{transform:scale(.97);}
.btn-save{background:var(--navy);color:#fff;}
.btn-save:hover{background:var(--navy2);}
.btn-save.saved{background:var(--green);}
.btn-ai{background:linear-gradient(135deg,var(--purple) 0%,#7c3aed 100%);color:#fff;box-shadow:0 3px 12px rgba(107,70,193,0.3);}
.btn-ai:hover{box-shadow:0 5px 20px rgba(107,70,193,0.45);}
.btn-ai:disabled{opacity:.5;cursor:not-allowed;}
.btn-primary{background:var(--navy);color:#fff;}
.btn-primary:hover{background:var(--navy2);}
.btn-ghost{background:#fff;border:1px solid var(--border);color:var(--text);}
.btn-ghost:hover{border-color:var(--navy);}
.btn-complete{background:var(--green);color:#fff;}
.btn-complete:hover{background:#256642;}

/* AI FEEDBACK PANEL */
.ai-feedback{background:var(--purple-dim);border:1px solid rgba(107,70,193,0.25);border-radius:var(--radius);padding:20px;margin-top:14px;display:none;}
.ai-feedback.show{display:block;animation:fadeUp .3s ease;}
.ai-feedback-header{display:flex;align-items:center;gap:8px;margin-bottom:14px;}
.ai-feedback-icon{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--purple),#7c3aed);display:grid;place-items:center;flex-shrink:0;}
.ai-feedback-title{font-family:'Playfair Display',serif;font-size:15px;font-weight:600;color:var(--purple);}
.ai-feedback-body{font-size:14px;line-height:1.7;color:var(--text);}
.ai-feedback-body strong{color:var(--navy);}
.ai-loading{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--purple);font-style:italic;}
.spinner{width:18px;height:18px;border:2px solid rgba(107,70,193,0.2);border-top-color:var(--purple);border-radius:50%;animation:spin .8s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg)}}

/* MCQ */
.mcq-block{background:#fff;border:2px solid var(--navy2);border-radius:var(--radius);padding:22px;margin:18px 0;}
.mcq-q{font-family:'Playfair Display',serif;font-size:16px;font-weight:600;margin-bottom:14px;color:var(--navy);}
.mcq-opts{display:flex;flex-direction:column;gap:7px;margin-bottom:12px;}
.mcq-opt{display:flex;align-items:center;gap:9px;padding:10px 13px;border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all .2s;user-select:none;}
.mcq-opt:hover:not(.disabled){border-color:var(--navy);background:rgba(26,39,68,0.04);}
.mcq-opt.selected{border-color:var(--navy);background:rgba(26,39,68,0.06);}
.mcq-opt.correct{border-color:var(--green);background:var(--green-dim);}
.mcq-opt.wrong{border-color:var(--red);background:var(--red-dim);}
.mcq-opt.disabled{cursor:default;}
.mcq-letter{width:24px;height:24px;border-radius:5px;background:var(--cream);border:1px solid var(--border);display:grid;place-items:center;font-size:11px;font-weight:700;flex-shrink:0;font-family:'DM Mono',monospace;}
.mcq-opt.correct .mcq-letter{background:var(--green-dim);border-color:var(--green);color:var(--green);}
.mcq-opt.wrong .mcq-letter{background:var(--red-dim);border-color:var(--red);color:var(--red);}
.mcq-fb{font-size:13px;padding:11px;border-radius:8px;display:none;margin-top:7px;}
.mcq-fb.show{display:block;}
.mcq-fb.correct{background:var(--green-dim);border:1px solid rgba(45,122,79,0.25);color:var(--green);}
.mcq-fb.wrong{background:var(--red-dim);border:1px solid rgba(192,57,43,0.2);color:var(--red);}

/* REFLECTION */
.refl-block{background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 100%);border-radius:var(--radius);padding:22px;margin:20px 0;color:#fff;}
.refl-icon{font-size:24px;margin-bottom:8px;}
.refl-title{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;margin-bottom:7px;}
.refl-block p{color:rgba(255,255,255,0.75);margin-bottom:10px;font-size:14px;}
textarea.refl-input{width:100%;min-height:90px;border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:11px;font-family:'Lora',serif;font-size:13px;background:rgba(255,255,255,0.07);color:#fff;resize:vertical;}
textarea.refl-input::placeholder{color:rgba(255,255,255,0.3);}
textarea.refl-input:focus{outline:none;border-color:var(--amber2);}

/* RESOURCES */
.res-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:14px 0;}
.res-card{background:var(--cream);border:1px solid var(--border);border-radius:8px;padding:13px;text-decoration:none;color:var(--text);transition:border-color .2s,transform .15s;display:flex;align-items:flex-start;gap:9px;}
.res-card:hover{border-color:var(--amber);transform:translateY(-2px);}
.res-icon{font-size:18px;flex-shrink:0;margin-top:1px;}
.res-title{font-size:13px;font-weight:600;margin-bottom:1px;color:var(--navy);}
.res-desc{font-size:11px;color:var(--muted);}

/* CHECKLIST */
.checklist{list-style:none;}
.checklist li{display:flex;align-items:flex-start;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);}
.checklist li:last-child{border-bottom:none;}
.checklist input[type=checkbox]{width:17px;height:17px;margin-top:2px;flex-shrink:0;cursor:pointer;accent-color:var(--navy);}
.checklist label{font-size:14px;cursor:pointer;line-height:1.5;}
.checklist label.checked{text-decoration:line-through;color:var(--muted);}

/* TIMELINE */
.tl-item{display:flex;gap:14px;margin-bottom:18px;}
.tl-left{display:flex;flex-direction:column;align-items:center;}
.tl-dot{width:30px;height:30px;border-radius:50%;background:var(--navy);color:#fff;display:grid;place-items:center;font-size:11px;font-weight:700;flex-shrink:0;font-family:'DM Mono',monospace;}
.tl-line{width:2px;flex:1;background:var(--border);margin:3px auto;}
.tl-body{flex:1;padding-bottom:18px;}
.tl-week{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--amber);margin-bottom:3px;font-family:'DM Mono',monospace;}
.tl-title{font-family:'Playfair Display',serif;font-size:15px;font-weight:600;color:var(--navy);margin-bottom:4px;}
.tl-body p{font-size:13px;margin-bottom:0;}

/* NAV BUTTONS */
.nav-btns{display:flex;gap:10px;margin-top:36px;padding-top:20px;border-top:1px solid var(--border);flex-wrap:wrap;}

@media(max-width:800px){
  .shell{grid-template-columns:1fr;}
  .sidebar{position:fixed;left:-270px;z-index:100;transition:left .3s;top:0;}
  .sidebar.open{left:0;}
  .res-grid{grid-template-columns:1fr;}
  .content-area{padding:20px 16px;}
  .topbar{padding:12px 16px;}
  
  .ivp-chat{max-height:320px;}
  .data-stat-grid{grid-template-columns:repeat(2,1fr);}
}

/* â”€â”€ INTERACTIVE VIDEO PLAYER â”€â”€ */
.ivp{background:var(--navy);border-radius:var(--radius);overflow:hidden;margin-bottom:28px;}
.ivp-head{padding:11px 16px;background:rgba(255,255,255,0.06);border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;gap:10px;}
.ivp-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.4);font-family:'DM Mono',monospace;}
.ivp-vid-title{font-size:13px;font-weight:600;color:#fff;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.ivp-ibtn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:rgba(255,255,255,0.85);border-radius:6px;padding:5px 13px;font-size:12px;cursor:pointer;transition:all .2s;font-family:'Lora',serif;font-weight:600;}
.ivp-ibtn:hover{background:rgba(255,255,255,0.18);}
.ivp-ibtn.on{background:var(--purple);border-color:var(--purple);color:#fff;}
.ivp-body{display:flex;flex-direction:column;}

.ivp-vcol{position:relative;min-width:0;width:100%;}
.ivp-wrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;overflow:hidden;}
.ivp-wrap>div,.ivp-wrap>iframe{position:absolute!important;top:0!important;left:0!important;width:100%!important;height:100%!important;border:none!important;}
.ivp-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(8,12,28,0.93);display:none;align-items:center;justify-content:center;z-index:20;backdrop-filter:blur(6px);padding:16px;}
.ivp-overlay.show{display:flex;}
.ivp-card{background:#fff;border-radius:12px;padding:22px 24px;max-width:500px;width:100%;box-shadow:0 12px 48px rgba(0,0,0,0.5);animation:fadeUp .25s ease;}
.ivp-card-tag{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;font-family:'DM Mono',monospace;margin-bottom:7px;}
.ivp-card-tag.mcq{color:var(--amber);}
.ivp-card-tag.refl{color:var(--purple);}
.ivp-time-tag{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:8px;}
.ivp-card-q{font-family:'Playfair Display',serif;font-size:17px;font-weight:600;color:var(--navy);margin-bottom:16px;line-height:1.4;}
.ivp-card textarea{width:100%;min-height:85px;border:1.5px solid var(--border);border-radius:8px;padding:11px;font-family:'Lora',serif;font-size:14px;resize:vertical;background:var(--cream);color:var(--text);}
.ivp-card textarea:focus{outline:none;border-color:var(--amber);}
.ivp-opts{display:flex;flex-direction:column;gap:7px;margin-bottom:12px;}
.ivp-opt{padding:10px 13px;border:1.5px solid var(--border);border-radius:8px;cursor:pointer;font-size:14px;transition:all .2s;display:flex;align-items:center;gap:10px;user-select:none;}
.ivp-opt:hover:not(.locked){border-color:var(--navy);background:rgba(26,39,68,0.04);}
.ivp-opt.correct{border-color:var(--green)!important;background:var(--green-dim);}
.ivp-opt.wrong{border-color:var(--red)!important;background:var(--red-dim);}
.ivp-opt.locked{cursor:default;}
.ivp-let{width:22px;height:22px;border-radius:4px;background:var(--cream);border:1px solid var(--border);display:grid;place-items:center;font-size:10px;font-weight:700;flex-shrink:0;font-family:'DM Mono',monospace;}
.ivp-opt.correct .ivp-let{background:var(--green-dim);border-color:var(--green);color:var(--green);}
.ivp-opt.wrong .ivp-let{background:var(--red-dim);border-color:var(--red);color:var(--red);}
.ivp-cfb{font-size:13px;padding:10px 13px;border-radius:8px;margin:6px 0 10px;display:none;line-height:1.5;}
.ivp-cfb.show{display:block;}
.ivp-cfb.ok{background:var(--green-dim);border:1px solid rgba(45,122,79,0.2);color:var(--green);}
.ivp-cfb.err{background:var(--red-dim);border:1px solid rgba(192,57,43,0.15);color:var(--red);}
.ivp-cbtns{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;}
.ivp-cbtns button{border:none;border-radius:7px;padding:9px 18px;font-size:13px;font-weight:600;cursor:pointer;font-family:'Lora',serif;transition:all .15s;}
.ivp-go{background:var(--navy);color:#fff;}
.ivp-go:hover{background:var(--navy2);}
.ivp-skip-btn{background:var(--cream);border:1px solid var(--border)!important;color:var(--muted);}
.ivp-skip-btn:hover{border-color:var(--navy)!important;}

/* CHAPTER BAR */
.ivp-chbar{padding:10px 14px 8px;background:rgba(0,0,0,0.2);}
.ivp-track{position:relative;height:4px;background:rgba(255,255,255,0.1);border-radius:4px;margin-bottom:8px;cursor:pointer;}
.ivp-fill{height:100%;background:var(--amber2);border-radius:4px;width:0%;transition:width .5s linear;pointer-events:none;}
.ivp-mkr{position:absolute;top:50%;transform:translate(-50%,-50%);width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.25);border:2px solid rgba(255,255,255,0.4);cursor:pointer;transition:all .2s;z-index:2;}
.ivp-mkr:hover,.ivp-mkr.on{background:var(--amber2);border-color:var(--amber2);transform:translate(-50%,-50%) scale(1.35);}
.ivp-mkr .ch-tip{position:absolute;bottom:160%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);color:#fff;padding:3px 8px;border-radius:5px;font-size:10px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s;font-family:'DM Mono',monospace;}
.ivp-mkr:hover .ch-tip{opacity:1;}
.ivp-ch-lbls{display:flex;gap:0;overflow-x:auto;scrollbar-width:none;}
.ivp-ch-lbls::-webkit-scrollbar{display:none;}
.ivp-ch-l{font-size:10px;color:rgba(255,255,255,0.3);cursor:pointer;padding:1px 10px 1px 0;white-space:nowrap;font-family:'DM Mono',monospace;transition:color .2s;}
.ivp-ch-l::before{content:'â—†';margin-right:5px;font-size:6px;vertical-align:middle;}
.ivp-ch-l:hover,.ivp-ch-l.on{color:var(--amber2);}

/* AI CHAT PANEL */
.ivp-chat{position:relative;z-index:1;background:rgba(0,0,0,0.18);border-top:2px solid rgba(255,255,255,0.08);display:none;flex-direction:column;max-height:340px;}
.ivp-chat-hd{padding:10px 13px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;align-items:center;gap:7px;flex-shrink:0;}
.ivp-chat-hd-ttl{font-size:13px;font-weight:700;color:#fff;flex:1;}
.ivp-chat-hd span.sub{font-size:10px;color:rgba(255,255,255,0.3);font-family:'DM Mono',monospace;}
.ivp-msgs{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:9px;max-height:320px;min-height:120px;}
.ivp-msg{padding:9px 12px;border-radius:9px;font-size:13px;line-height:1.55;max-width:96%;}
.ivp-msg.ai{background:rgba(107,70,193,0.18);border:1px solid rgba(107,70,193,0.2);color:rgba(255,255,255,0.85);align-self:flex-start;}
.ivp-msg.usr{background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.9);align-self:flex-end;}
.ivp-chat-inp-row{padding:9px 11px;border-top:1px solid rgba(255,255,255,0.07);display:flex;gap:7px;flex-shrink:0;}
.ivp-chat-ta{flex:1;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.13);border-radius:7px;padding:8px 10px;color:#fff;font-family:'Lora',serif;font-size:13px;resize:none;min-height:36px;max-height:72px;line-height:1.4;}
.ivp-chat-ta::placeholder{color:rgba(255,255,255,0.2);}
.ivp-chat-ta:focus{outline:none;border-color:rgba(107,70,193,0.6);}
.ivp-chat-send{background:var(--purple);color:#fff;border:none;border-radius:7px;padding:7px 12px;cursor:pointer;font-size:13px;font-weight:700;align-self:flex-end;transition:opacity .2s;}
.ivp-chat-send:disabled{opacity:.35;cursor:not-allowed;}

/* DATA DASHBOARD */
.data-dash{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-top:16px;}
.data-stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:12px 0 16px;}
.data-stat{background:var(--cream);border:1px solid var(--border);border-radius:8px;padding:13px;text-align:center;}
.data-stat-n{font-family:'Playfair Display',serif;font-size:26px;font-weight:700;color:var(--navy);}
.data-stat-l{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:2px;text-transform:uppercase;letter-spacing:.5px;}
.data-tbl{width:100%;border-collapse:collapse;font-size:12px;margin-top:10px;}
.data-tbl th{background:var(--navy);color:#fff;padding:7px 10px;text-align:left;font-family:'DM Mono',monospace;font-weight:600;font-size:11px;}
.data-tbl td{padding:7px 10px;border-bottom:1px solid var(--border);vertical-align:top;}
.data-tbl tr:last-child td{border-bottom:none;}
.data-tbl tr:nth-child(even) td{background:rgba(250,248,243,0.6);}
.dtype{display:inline-block;padding:1px 7px;border-radius:4px;font-size:10px;font-weight:700;font-family:'DM Mono',monospace;text-transform:uppercase;}
.dtype.mcq{background:var(--amber-dim);color:var(--amber);}
.dtype.reflection{background:var(--purple-dim);color:var(--purple);}
/* â”€â”€ LOGIN / REGISTER SCREEN â”€â”€ */
#auth-screen{position:fixed;inset:0;background:var(--navy);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;}
#auth-screen.hidden{display:none;}
.auth-box{background:#fff;border-radius:16px;width:100%;max-width:520px;overflow:hidden;box-shadow:0 24px 80px rgba(0,0,0,0.5);}
.auth-hero{background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 100%);padding:30px 32px 24px;color:#fff;position:relative;overflow:hidden;}
.auth-hero::after{content:'';position:absolute;right:-30px;top:-30px;width:160px;height:160px;border-radius:50%;background:rgba(255,255,255,0.04);}
.auth-hero-logo{font-size:10px;letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,0.4);font-family:'DM Mono',monospace;margin-bottom:6px;}
.auth-hero-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;line-height:1.3;margin-bottom:4px;}
.auth-hero-sub{font-size:12px;color:rgba(255,255,255,0.5);font-family:'DM Mono',monospace;}
.auth-tabs{display:flex;border-bottom:1px solid var(--border);}
.auth-tab{flex:1;padding:14px;text-align:center;font-size:13px;font-weight:700;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .2s;font-family:'Lora',serif;}
.auth-tab.on{color:var(--navy);border-bottom-color:var(--amber);}
.auth-body{padding:24px 28px 28px;}
.auth-form{display:none;}
.auth-form.on{display:block;}
.auth-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.auth-field{margin-bottom:14px;}
.auth-field label{display:block;font-size:12px;font-weight:700;color:var(--navy);margin-bottom:5px;font-family:'DM Mono',monospace;text-transform:uppercase;letter-spacing:.5px;}
.auth-field label .opt{font-weight:400;color:var(--muted);text-transform:none;letter-spacing:0;}
.auth-field input,.auth-field select{width:100%;border:1.5px solid var(--border);border-radius:8px;padding:10px 13px;font-family:'Lora',serif;font-size:14px;color:var(--text);background:#fff;transition:border-color .2s;}
.auth-field input:focus,.auth-field select:focus{outline:none;border-color:var(--amber);}
.auth-field input.err{border-color:var(--red);}
.auth-err{font-size:12px;color:var(--red);margin-top:-8px;margin-bottom:10px;display:none;}
.auth-err.show{display:block;}
.auth-submit{width:100%;background:var(--navy);color:#fff;border:none;border-radius:9px;padding:13px;font-family:'Playfair Display',serif;font-size:16px;font-weight:700;cursor:pointer;transition:background .2s;margin-top:4px;}
.auth-submit:hover{background:var(--navy2);}
.auth-note{font-size:11px;color:var(--muted);text-align:center;margin-top:13px;line-height:1.5;}
.auth-sep{border:none;border-top:1px solid var(--border);margin:16px 0;}

/* Profile modal */
#profile-modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:8888;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);}
#profile-modal.show{display:flex;}
.profile-box{background:#fff;border-radius:14px;width:100%;max-width:540px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.4);}
.profile-hd{padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.profile-hd-title{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;flex:1;}
.profile-close{background:none;border:1px solid var(--border);border-radius:6px;padding:5px 11px;cursor:pointer;font-size:13px;}
.profile-body{padding:20px 24px 24px;}

/* Student chip in topbar */
.student-chip{display:flex;align-items:center;gap:8px;background:rgba(26,39,68,0.06);border:1px solid var(--border);border-radius:20px;padding:5px 12px 5px 8px;cursor:pointer;transition:border-color .2s;user-select:none;}
.student-chip:hover{border-color:var(--navy);}
.student-avatar{width:24px;height:24px;border-radius:50%;background:var(--navy);color:#fff;display:grid;place-items:center;font-size:10px;font-weight:700;flex-shrink:0;font-family:'DM Mono',monospace;}
.student-name{font-size:12px;font-weight:600;color:var(--navy);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.btn-logout{background:none;border:1px solid var(--border);border-radius:6px;padding:6px 12px;font-size:12px;cursor:pointer;color:var(--muted);font-family:'Lora',serif;transition:all .2s;}
.btn-logout:hover{border-color:var(--red);color:var(--red);}
/* â”€â”€ ROLE SELECTOR â”€â”€ */
.role-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px;}
.role-opt{padding:11px 6px;border:2px solid var(--border);border-radius:8px;text-align:center;cursor:pointer;transition:all .2s;user-select:none;}
.role-opt:hover{border-color:var(--navy);}
.role-opt.active{border-color:var(--amber);background:var(--amber-dim);}
.role-icon{display:block;font-size:20px;margin-bottom:3px;}
.role-lbl{font-size:11px;font-weight:700;font-family:'DM Mono',monospace;color:var(--navy);}

/* â”€â”€ CLOUD SYNC INDICATOR â”€â”€ */
.btn-save.synced{border-color:var(--green)!important;color:var(--green)!important;}

/* â”€â”€ SUPERVISOR / LECTURER DASHBOARD â”€â”€ */
#sup-screen{position:fixed;inset:0;z-index:9000;background:var(--cream);display:none;flex-direction:column;}
#sup-screen.show{display:flex;}
.sup-header{background:var(--navy);color:#fff;padding:14px 22px;display:flex;align-items:center;gap:12px;flex-shrink:0;}
.sup-header-logo{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);font-family:'DM Mono',monospace;}
.sup-divider{width:1px;height:20px;background:rgba(255,255,255,0.1);}
.sup-role-pill{padding:3px 10px;border-radius:20px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;font-family:'DM Mono',monospace;}
.sup-role-pill.supervisor{background:rgba(107,70,193,0.3);color:#c4b5fd;}
.sup-role-pill.lecturer{background:rgba(201,125,46,0.25);color:var(--amber2);}
.sup-hd-name{font-family:'Playfair Display',serif;font-size:15px;font-weight:700;}
.sup-hd-inst{font-size:11px;color:rgba(255,255,255,0.35);font-family:'DM Mono',monospace;}
.sup-hd-btns{margin-left:auto;display:flex;gap:7px;}
.sup-hd-btn{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:rgba(255,255,255,0.7);border-radius:6px;padding:6px 13px;font-size:12px;cursor:pointer;font-family:'Lora',serif;transition:all .2s;}
.sup-hd-btn:hover{background:rgba(255,255,255,0.15);}
.sup-body{display:grid;grid-template-columns:280px 1fr;flex:1;overflow:hidden;}
.sup-sidebar{background:var(--navy);color:#fff;display:flex;flex-direction:column;border-right:1px solid rgba(255,255,255,0.05);overflow:hidden;}
.sup-sidebar-inner{flex:1;overflow-y:auto;padding:12px 10px;}
.sup-sec-ttl{font-size:9px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,0.2);font-family:'DM Mono',monospace;padding:4px 6px 8px;}
.sup-stu-item{padding:10px 11px;border-radius:7px;cursor:pointer;transition:background .15s;margin-bottom:3px;border:1px solid transparent;}
.sup-stu-item:hover{background:rgba(255,255,255,0.07);}
.sup-stu-item.active{background:rgba(255,255,255,0.11);border-color:rgba(255,255,255,0.1);}
.sup-stu-name{font-size:13px;font-weight:600;color:#fff;}
.sup-stu-meta{font-size:10px;color:rgba(255,255,255,0.3);font-family:'DM Mono',monospace;margin-top:1px;}
.sup-mini-bar{height:3px;background:rgba(255,255,255,0.07);border-radius:3px;margin-top:5px;overflow:hidden;}
.sup-mini-fill{height:100%;border-radius:3px;background:var(--amber2);transition:width .5s;}
.sup-sidebar-ft{padding:11px 10px;border-top:1px solid rgba(255,255,255,0.06);}
.sup-ft-btn{width:100%;padding:9px;border-radius:7px;font-size:12px;cursor:pointer;font-family:'Lora',serif;margin-bottom:6px;transition:all .2s;border:none;}
.sup-ft-btn.primary{background:var(--amber);color:#fff;font-weight:700;}
.sup-ft-btn.primary:hover{background:var(--amber2);}
.sup-ft-btn.ghost{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1)!important;color:rgba(255,255,255,0.4);}
.sup-ft-btn.ghost:hover{color:rgba(255,255,255,0.7);}
.sup-add-btn{width:100%;padding:8px;background:none;border:1px dashed rgba(255,255,255,0.12)!important;color:rgba(255,255,255,0.3);border-radius:7px;cursor:pointer;font-size:11px;font-family:'Lora',serif;margin-top:4px;transition:all .2s;}
.sup-add-btn:hover{border-color:rgba(255,255,255,0.3)!important;color:rgba(255,255,255,0.7);}
.sup-main{overflow-y:auto;background:var(--cream);}
.sup-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:10px;color:var(--muted);}
.sup-empty-icon{font-size:44px;}
.sup-empty-ttl{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--navy);}
.sup-empty-sub{font-size:14px;}
.sup-detail{padding:26px 30px;max-width:860px;}
.sup-det-hd{display:flex;align-items:flex-start;gap:16px;margin-bottom:20px;padding-bottom:18px;border-bottom:2px solid var(--border);}
.sup-det-av{width:52px;height:52px;border-radius:50%;background:var(--navy);color:#fff;display:grid;place-items:center;font-size:18px;font-weight:700;font-family:'DM Mono',monospace;flex-shrink:0;}
.sup-det-name{font-family:'Playfair Display',serif;font-size:21px;font-weight:700;color:var(--navy);}
.sup-det-meta{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:3px;}
.sup-det-topic{font-size:14px;margin-top:6px;font-style:italic;}
.sup-prog-block{background:#fff;border:1px solid var(--border);border-radius:8px;padding:13px 16px;margin-bottom:18px;}
.sup-prog-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:7px;}
.sup-prog-track{height:8px;background:var(--cream);border-radius:8px;overflow:hidden;margin-bottom:4px;border:1px solid var(--border);}
.sup-prog-fill{height:100%;border-radius:8px;background:var(--green);transition:width .6s;}
.sup-prog-nums{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;}
.sup-sh{font-family:'Playfair Display',serif;font-size:16px;font-weight:700;color:var(--navy);margin:20px 0 9px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.sup-ex-card{background:#fff;border:1px solid var(--border);border-radius:8px;padding:13px 15px;margin-bottom:7px;}
.sup-ex-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:5px;}
.sup-ex-text{font-size:14px;line-height:1.65;white-space:pre-wrap;word-break:break-word;}
.sup-ex-empty{font-size:13px;color:var(--muted);font-style:italic;}
.sup-ex-date{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:5px;}
.sup-vr-item{background:#fff;border:1px solid var(--border);border-radius:8px;padding:10px 14px;margin-bottom:6px;display:flex;gap:11px;align-items:flex-start;}
.sup-vr-tag{flex-shrink:0;padding:2px 7px;border-radius:4px;font-size:9px;font-weight:700;text-transform:uppercase;font-family:'DM Mono',monospace;margin-top:2px;}
.sup-vr-tag.mcq{background:var(--amber-dim);color:var(--amber);}
.sup-vr-tag.reflection{background:var(--purple-dim);color:var(--purple);}
.sup-vr-q{font-size:12px;color:var(--muted);margin-bottom:3px;line-height:1.4;}
.sup-vr-a{font-size:13px;line-height:1.5;}
.sup-vr-result{font-size:11px;font-family:'DM Mono',monospace;margin-top:3px;}
.sup-comments-wrap{background:var(--cream);border:1px solid var(--border);border-radius:10px;padding:15px 17px;}
.sup-comment{padding:10px 0;border-bottom:1px solid var(--border);}
.sup-comment:last-child{border-bottom:none;}
.sup-comment-meta{font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:4px;}
.sup-comment-text{font-size:14px;line-height:1.55;}
.sup-cta{width:100%;min-height:70px;border:1.5px solid var(--border);border-radius:8px;padding:10px;font-family:'Lora',serif;font-size:14px;background:#fff;resize:vertical;margin-top:12px;}
.sup-cta:focus{outline:none;border-color:var(--amber);}
.sup-no-fb{background:var(--amber-dim);border:1px solid rgba(201,125,46,0.25);border-radius:10px;padding:18px;text-align:center;}
@media(max-width:800px){.sup-body{grid-template-columns:1fr;}.sup-sidebar{max-height:220px;}}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN / REGISTER SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="auth-screen">
  <div class="auth-box">
    <div class="auth-hero">
      <div class="auth-hero-logo">Masters in Education</div>
      <div class="auth-hero-title">MEd Dissertation Unit</div>
      <div class="auth-hero-sub">Sign in or create your account to begin</div>
    </div>
    <div class="auth-tabs">
      <div class="auth-tab on" id="tab-login" onclick="authTab('login')">Sign In</div>
      <div class="auth-tab" id="tab-register" onclick="authTab('register')">Create Account</div>
    </div>
    <div class="auth-body">

      <!-- LOGIN FORM -->
      <div class="auth-form on" id="form-login">
        <div class="auth-field">
          <label>Username</label>
          <input type="text" id="l-user" placeholder="your username" autocomplete="username"/>
        </div>
        <div class="auth-field">
          <label>Password</label>
          <input type="password" id="l-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeydown="if(event.key==='Enter') doLogin()"/>
        </div>
        <div class="auth-err" id="l-err">Incorrect username or password.</div>
        <button class="auth-submit" onclick="doLogin()">Sign In â†’</button>
        <p class="auth-note">Don't have an account? Click <strong>Create Account</strong> above.<br>Your data is stored in this browser only â€” not on a server.</p>
        <p style="text-align:center;margin-top:8px"><span onclick="devBypass()" style="font-size:10px;color:var(--border);cursor:pointer;font-family:'DM Mono',monospace;letter-spacing:1px;user-select:none" title="Developer access">Â· Â· Â·</span></p>
      </div>

      <!-- REGISTER FORM -->
      <div class="auth-form" id="form-register">

        <!-- Role selector -->
        <div class="auth-field" style="margin-bottom:16px">
          <label>I am registering as a:</label>
          <div class="role-selector">
            <div class="role-opt active" id="role-opt-student" onclick="setRegRole('student')">
              <span class="role-icon">ğŸ“</span><span class="role-lbl">Student</span>
            </div>
            <div class="role-opt" id="role-opt-supervisor" onclick="setRegRole('supervisor')">
              <span class="role-icon">ğŸ‘©â€ğŸ«</span><span class="role-lbl">Supervisor</span>
            </div>
            <div class="role-opt" id="role-opt-lecturer" onclick="setRegRole('lecturer')">
              <span class="role-icon">ğŸ“š</span><span class="role-lbl">Lecturer</span>
            </div>
          </div>
          <input type="hidden" id="r-role" value="student"/>
        </div>

        <div class="auth-row">
          <div class="auth-field">
            <label>First Name</label>
            <input type="text" id="r-first" placeholder="First name"/>
          </div>
          <div class="auth-field">
            <label>Last Name</label>
            <input type="text" id="r-last" placeholder="Last name"/>
          </div>
        </div>
        <div class="auth-row">
          <div class="auth-field">
            <label>Username</label>
            <input type="text" id="r-user" placeholder="Choose a username"/>
          </div>
          <div class="auth-field">
            <label id="r-id-label">Student Number</label>
            <input type="text" id="r-snum" placeholder="e.g. 2024001234"/>
          </div>
        </div>
        <div class="auth-row">
          <div class="auth-field">
            <label>Password</label>
            <input type="password" id="r-pass" placeholder="Min. 6 characters"/>
          </div>
          <div class="auth-field">
            <label>Confirm Password</label>
            <input type="password" id="r-pass2" placeholder="Repeat password"/>
          </div>
        </div>
        <hr class="auth-sep"/>
        <div class="auth-field">
          <label>Institution / University</label>
          <input type="text" id="r-inst" placeholder="e.g. University of Cape Town"/>
        </div>

        <!-- â”€â”€ Student-only fields â”€â”€ -->
        <div id="stu-only-fields">
          <div class="auth-row">
            <div class="auth-field">
              <label>Programme</label>
              <select id="r-prog">
                <option value="">Selectâ€¦</option>
                <option>MEd Education</option>
                <option>MEd Teaching & Learning</option>
                <option>MEd Curriculum Studies</option>
                <option>MEd Educational Leadership</option>
                <option>MEd Inclusive Education</option>
                <option>MEd TESOL / Language Education</option>
                <option>Other Masters</option>
              </select>
            </div>
            <div class="auth-field">
              <label>Year of Study</label>
              <select id="r-year">
                <option value="">Selectâ€¦</option>
                <option>Year 1 (Full-time)</option>
                <option>Year 2 (Full-time)</option>
                <option>Year 1 (Part-time)</option>
                <option>Year 2 (Part-time)</option>
                <option>Year 3 (Part-time)</option>
              </select>
            </div>
          </div>
          <div class="auth-field">
            <label>Supervisor Username <span class="opt">(your supervisor's login username on this platform)</span></label>
            <input type="text" id="r-sup" placeholder="e.g. drmokoena"/>
          </div>
          <div class="auth-field">
            <label>Research Area / Dissertation Topic <span class="opt">(as much as you know)</span></label>
            <input type="text" id="r-topic" placeholder="e.g. Inclusive education practices in township schools"/>
          </div>
          <div class="auth-row">
            <div class="auth-field">
              <label>Language of Instruction</label>
              <select id="r-lang">
                <option value="">Selectâ€¦</option>
                <option>English</option>
                <option>Afrikaans</option>
                <option>Zulu</option>
                <option>Xhosa</option>
                <option>Sotho</option>
                <option>Tswana</option>
                <option>French</option>
                <option>Portuguese</option>
                <option>Other</option>
              </select>
            </div>
            <div class="auth-field">
              <label>Email <span class="opt">(optional)</span></label>
              <input type="email" id="r-email" placeholder="your@email.com"/>
            </div>
          </div>
        </div>

        <!-- â”€â”€ Supervisor / Lecturer-only fields â”€â”€ -->
        <div id="sup-only-fields" style="display:none">
          <div class="auth-row">
            <div class="auth-field">
              <label>Department / Faculty</label>
              <input type="text" id="r-dept" placeholder="e.g. School of Education"/>
            </div>
            <div class="auth-field">
              <label>Email</label>
              <input type="email" id="r-email-sup" placeholder="your@university.ac.za"/>
            </div>
          </div>
          <div class="auth-field">
            <label>Academic Role</label>
            <select id="r-acad-role">
              <option>Dissertation Supervisor</option>
              <option>Module Lecturer</option>
              <option>Programme Coordinator</option>
              <option>Head of Department</option>
              <option>Course Administrator</option>
            </select>
          </div>
          <div class="info-box" style="margin:10px 0 0;padding:12px 14px">
            <div style="font-size:11px;color:var(--navy)">ğŸ’¡ <strong>Supervisor setup:</strong> After registering, share your <strong>username</strong> with your students. They enter it when registering so their work is assigned to you automatically.</div>
          </div>
        </div>

        <div class="auth-err" id="r-err">Please check the fields above.</div>
        <button class="auth-submit" id="r-submit" onclick="doRegister()">Create Account & Begin â†’</button>
        <p class="auth-note">All data is stored locally in your browser and (if configured) in Firebase.<br>âš ï¸ Use a password you don't use elsewhere â€” this is not a high-security system.</p>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PROFILE MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="profile-modal">
  <div class="profile-box">
    <div class="profile-hd">
      <span style="font-size:20px">ğŸ‘¤</span>
      <span class="profile-hd-title">My Profile</span>
      <button class="profile-close" onclick="closeProfile()">âœ• Close</button>
    </div>
    <div class="profile-body" id="profile-body"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SUPERVISOR / LECTURER DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="sup-screen">
  <div class="sup-header">
    <span class="sup-header-logo">MEd Dissertation</span>
    <div class="sup-divider"></div>
    <span class="sup-role-pill" id="sup-role-pill">Supervisor</span>
    <span class="sup-hd-name" id="sup-hd-name">Loadingâ€¦</span>
    <span class="sup-hd-inst" id="sup-hd-inst"></span>
    <div class="sup-hd-btns">
      <button class="sup-hd-btn" onclick="openProfile()">ğŸ‘¤ Profile</button>
      <button class="sup-hd-btn" onclick="doLogout()">Sign Out</button>
    </div>
  </div>
  <div class="sup-body">
    <aside class="sup-sidebar">
      <div class="sup-sidebar-inner">
        <div class="sup-sec-ttl">Students</div>
        <div id="sup-stu-list"><div style="color:rgba(255,255,255,0.25);font-size:12px;padding:6px;font-style:italic">Loadingâ€¦</div></div>
        <button class="sup-add-btn" onclick="supAddStudent()">+ Add student by username</button>
      </div>
      <div class="sup-sidebar-ft">
        <button class="sup-ft-btn primary" onclick="supExportAll()">â¬‡ Export All Data (CSV)</button>
        <button class="sup-ft-btn ghost" onclick="doLogout()">Sign Out</button>
      </div>
    </aside>
    <main class="sup-main" id="sup-main">
      <div class="sup-empty">
        <div class="sup-empty-icon">ğŸ“‹</div>
        <div class="sup-empty-ttl">Select a student</div>
        <div class="sup-empty-sub">Click a student in the sidebar to view their work</div>
      </div>
    </main>
  </div>
</div>

<div class="shell">

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">Masters in Education</div>
    <div class="sidebar-title">Dissertation Unit</div>
    <div class="sidebar-sub">Proposal â†’ Completion</div>
  </div>
  <div class="prog-wrap">
    <div class="prog-label">Your progress</div>
    <div class="prog-bg"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
    <div class="prog-txt" id="prog-txt">0 of 9 units complete</div>
  </div>
  <nav class="nav-list" id="nav-list"></nav>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <span class="unit-badge" id="topbar-badge">Welcome</span>
    <span class="unit-title-bar" id="topbar-title">Programme Overview</span>
    <div class="topbar-btns">
      <button class="btn btn-ghost" onclick="prevMod()">â† Back</button>
      <button class="btn btn-primary" onclick="nextMod()">Next â†’</button>
      <div class="student-chip" id="student-chip" onclick="openProfile()" title="View / edit your profile" style="display:none">
        <div class="student-avatar" id="student-avatar">?</div>
        <span class="student-name" id="student-name-chip">Student</span>
      </div>
      <button class="btn-logout" id="btn-logout" onclick="doLogout()" style="display:none" title="Sign out">Sign out</button>
    </div>
  </div>
  <div class="content-area" id="content-area"></div>
</div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH SYSTEM â€” Login, Register, Profile, Session
   Data stored in localStorage (browser-only, no server)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€ Helpers â”€â”€
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ”¥ FIREBASE â€” Auth + Realtime Database
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GET YOUR API KEY (one-time setup):
   Firebase Console â†’ âš™ Project Settings â†’ General â†’
   Your Apps â†’ click </> Web â†’ Register app â†’ copy apiKey value
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const FB_CONFIG = {
  apiKey:        'AIzaSyAAcz6ixFsU1ZW32bY7YHs56qA7l3FXA-w',   // â† paste your key here
  authDomain:    'masters-cohort-supervision.firebaseapp.com',
  databaseURL:   'https://masters-cohort-supervision-default-rtdb.firebaseio.com',
  projectId:     'masters-cohort-supervision',
  storageBucket: 'masters-cohort-supervision.appspot.com'
};

let FB_AUTH = null;
let FB_DB   = null;
let FB_ON   = false;

try {
  if (typeof firebase !== 'undefined' && FB_CONFIG.apiKey !== 'YOUR_API_KEY_HERE') {
    firebase.initializeApp(FB_CONFIG);
    FB_AUTH = firebase.auth();
    FB_DB   = firebase.database();
    FB_ON   = true;
  }
} catch(e) {
  console.warn('Firebase init failed â€” running in offline mode:', e.message);
}

// â”€â”€ Firebase DB helpers (SDK handles auth token automatically) â”€â”€
async function fbGet(path) {
  if (!FB_ON || !FB_DB) return null;
  try { const s = await FB_DB.ref(path).once('value'); return s.val(); } catch(e) { return null; }
}
async function fbSet(path, data) {
  if (!FB_ON || !FB_DB) return;
  try { await FB_DB.ref(path).set(data); } catch(e) {}
}
async function fbUpdate(path, data) {
  if (!FB_ON || !FB_DB) return;
  try { await FB_DB.ref(path).update(data); } catch(e) {}
}
async function fbPush(path, data) {
  if (!FB_ON || !FB_DB) return;
  try { await FB_DB.ref(path).push(data); } catch(e) {}
}

// â”€â”€ In-memory session (Firebase Auth handles persistence) â”€â”€
let _currentProfile = null;
function getSession()   { return _currentProfile; }
function saveSession(p) { _currentProfile = p; if (!FB_ON) { try { localStorage.setItem('diss-session-v2', JSON.stringify(p)); } catch(e) {} } }
function clearSession() { _currentProfile = null; }

// â”€â”€ Tab switcher â”€â”€
function authTab(t) {
  ['login','register'].forEach(x => {
    document.getElementById('form-'+x).classList.toggle('on', x===t);
    document.getElementById('tab-'+x).classList.toggle('on', x===t);
  });
  document.getElementById('l-err').classList.remove('show');
  document.getElementById('r-err').classList.remove('show');
}

// â”€â”€ Login â€” Firebase Auth â”€â”€
async function doLogin() {
  const uname = document.getElementById('l-user').value.trim().toLowerCase();
  const pass  = document.getElementById('l-pass').value;
  const err   = document.getElementById('l-err');
  err.classList.remove('show');
  if (!uname || !pass) { err.textContent='Please enter your username and password.'; err.classList.add('show'); return; }
  const btn = document.querySelector('#form-login .auth-submit');
  if (btn) { btn.disabled=true; btn.textContent='Signing inâ€¦'; }
  try {
    const email = `${uname}@masters-cohort-supervision.app`;
    if (!FB_ON || !FB_AUTH) throw new Error('offline');
    await FB_AUTH.signInWithEmailAndPassword(email, pass);
    // onAuthStateChanged fires next and calls bootApp
  } catch(e) {
    err.textContent = 'Incorrect username or password.';
    err.classList.add('show');
    if (btn) { btn.disabled=false; btn.textContent='Sign In â†’'; }
  }
}

// â”€â”€ Register â€” Firebase Auth + save profile to DB â”€â”€
async function doRegister() {
  const get = id => (document.getElementById(id)?.value||'').trim();
  const err = document.getElementById('r-err');
  err.classList.remove('show');
  const role  = get('r-role') || 'student';
  const isStu = role === 'student';
  const errs  = [];
  if (!get('r-first')) errs.push('First name required');
  if (!get('r-last'))  errs.push('Last name required');
  const uname = get('r-user').toLowerCase().replace(/\s+/g,'');
  if (!uname)          errs.push('Username required');
  if (!get('r-pass') || get('r-pass').length < 6) errs.push('Password must be at least 6 characters');
  if (get('r-pass') !== get('r-pass2')) errs.push('Passwords do not match');
  if (errs.length) { err.textContent=errs[0]+'.'; err.classList.add('show'); return; }

  const btn = document.getElementById('r-submit');
  if (btn) { btn.disabled=true; btn.textContent='Creating accountâ€¦'; }

  // Check username not already taken
  if (FB_ON) {
    const existing = await fbGet(`usernames/${uname}`);
    if (existing) { err.textContent='That username is already taken.'; err.classList.add('show'); if (btn){btn.disabled=false;btn.textContent='Create Account & Begin â†’';} return; }
  }

  const profile = {
    username:    uname,
    role,
    firstName:   get('r-first'),
    lastName:    get('r-last'),
    studentNum:  get('r-snum'),
    email:       isStu ? get('r-email') : get('r-email-sup'),
    institution: get('r-inst'),
    programme:   isStu ? (document.getElementById('r-prog')?.value||'') : '',
    yearOfStudy: isStu ? (document.getElementById('r-year')?.value||'') : '',
    supervisorUsername: isStu ? get('r-sup') : '',
    researchArea:isStu ? get('r-topic') : '',
    language:    isStu ? (document.getElementById('r-lang')?.value||'') : '',
    department:  !isStu ? get('r-dept') : '',
    academicRole:!isStu ? (document.getElementById('r-acad-role')?.value||'') : '',
    registered:  new Date().toISOString()
  };

  if (!FB_ON) {
    // Offline fallback â€” localStorage only
    saveSession({...profile, uid:'local-'+uname});
    bootApp({...profile, uid:'local-'+uname});
    return;
  }

  try {
    const fbEmail = `${uname}@masters-cohort-supervision.app`;
    const cred = await FB_AUTH.createUserWithEmailAndPassword(fbEmail, get('r-pass'));
    const uid  = cred.user.uid;
    profile.uid = uid;
    // Save profile to DB
    await fbSet(`users/${uid}`, profile);
    // Save username â†’ uid mapping (used for supervisor lookups)
    await fbSet(`usernames/${uname}`, uid);
    // If student with a supervisor, link to supervisor
    if (isStu && profile.supervisorUsername) {
      const supUid = await fbGet(`usernames/${profile.supervisorUsername}`);
      if (supUid) await fbSet(`supervisorStudents/${supUid}/${uid}`, {
        firstName:profile.firstName, lastName:profile.lastName,
        studentNum:profile.studentNum, researchArea:profile.researchArea,
        programme:profile.programme, registeredAt:profile.registered
      });
    }
    // onAuthStateChanged fires and calls bootApp
  } catch(e) {
    const msg = e.code === 'auth/email-already-in-use' ? 'That username is already registered.'
              : e.code === 'auth/weak-password' ? 'Password must be at least 6 characters.'
              : e.message || 'Registration failed â€” please try again.';
    err.textContent = msg; err.classList.add('show');
    if (btn) { btn.disabled=false; btn.textContent='Create Account & Begin â†’'; }
  }
}

// â”€â”€ Logout â”€â”€
async function doLogout() {
  if (!confirm('Sign out? Your progress is saved.')) return;
  if (FB_ON && FB_AUTH) await FB_AUTH.signOut();
  clearSession();
  localStorage.removeItem('diss-session-v2');
  location.reload();
}

// â”€â”€ Developer bypass (skips Firebase Auth entirely) â”€â”€
const DEV_PASS = 'dev2024';
const DEV_USER = {
  uid:'dev-uid', username:'developer', role:'lecturer',
  firstName:'Developer', lastName:'Admin', studentNum:'DEV-001',
  institution:'Course Administration', programme:'MEd Education',
  yearOfStudy:'N/A', supervisorUsername:'', researchArea:'Course Development & Testing',
  language:'English', email:'', registered:new Date().toISOString(), _isDev:true
};

function devBypass() {
  const code = prompt('Developer pass:');
  if (code === null) return;
  if (code === DEV_PASS) { saveSession(DEV_USER); bootApp(DEV_USER); }
}
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.shiftKey && e.key==='D') {
    e.preventDefault();
    const s = document.getElementById('auth-screen');
    if (s && !s.classList.contains('hidden')) devBypass();
  }
});

// â”€â”€ Boot app after auth â”€â”€
function bootApp(user) {
  document.getElementById('auth-screen').classList.add('hidden');
  const role = user.role || 'student';
  const initials = ((user.firstName||'?')[0]+(user.lastName||'')[0]).toUpperCase();
  if (role === 'supervisor' || role === 'lecturer') {
    const sup = document.getElementById('sup-screen');
    if (sup) sup.classList.add('show');
    document.getElementById('sup-hd-name').textContent = user.firstName+' '+user.lastName;
    document.getElementById('sup-hd-inst').textContent = (user.department?user.department+' Â· ':'')+(user.institution||'');
    const pill = document.getElementById('sup-role-pill');
    pill.textContent = role==='lecturer'?'Lecturer / Admin':'Supervisor';
    pill.className = 'sup-role-pill '+role;
    loadSupStudents(user);
  } else {
    document.getElementById('student-avatar').textContent = initials;
    document.getElementById('student-name-chip').textContent = user.firstName+' '+user.lastName;
    document.getElementById('student-chip').style.display = 'flex';
    document.getElementById('btn-logout').style.display = 'block';
    const sub = document.querySelector('.sidebar-sub');
    if (sub) sub.textContent = user.studentNum||user.username;
    initApp();
  }
}

// â”€â”€ Firebase Auth state listener â€” with offline fallback â”€â”€
if (FB_ON && FB_AUTH) {
  FB_AUTH.onAuthStateChanged(async function(fbUser) {
    if (fbUser) {
      const profile = await fbGet(`users/${fbUser.uid}`);
      if (profile) { saveSession(profile); bootApp(profile); }
      else { await FB_AUTH.signOut(); }
    }
    // else: auth screen stays visible
  });
} else {
  // Firebase not configured â€” check localStorage session as fallback
  const stored = localStorage.getItem('diss-session-v2');
  if (stored) { try { const p = JSON.parse(stored); saveSession(p); bootApp(p); } catch(e) {} }
}

// â”€â”€ Profile modal â”€â”€
function openProfile() {
  const user = getSession(); if (!user) return;
  const modal = document.getElementById('profile-modal');
  const body  = document.getElementById('profile-body');
  body.innerHTML = `
<div style="margin-bottom:18px">
  <div style="display:flex;align-items:center;gap:14px;margin-bottom:16px">
    <div style="width:50px;height:50px;border-radius:50%;background:var(--navy);color:#fff;display:grid;place-items:center;font-size:18px;font-weight:700;font-family:'DM Mono',monospace;flex-shrink:0">${(user.firstName[0]||'?')+(user.lastName[0]||'')}</div>
    <div>
      <div style="font-family:'Playfair Display',serif;font-size:18px;font-weight:700">${user.firstName} ${user.lastName}</div>
      <div style="font-size:12px;color:var(--muted);font-family:'DM Mono',monospace">${user.username} Â· ${user.studentNum||'No student number'}</div>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
    ${profileField('Institution', user.institution)}
    ${profileField('Programme', user.programme)}
    ${profileField('Year of Study', user.yearOfStudy)}
    ${profileField('Language', user.language)}
    ${profileField('Supervisor Username', user.supervisorUsername)}
    ${profileField('Email', user.email)}
  </div>
  ${user.researchArea?`<div style="background:var(--amber-dim);border:1px solid rgba(201,125,46,0.2);border-radius:8px;padding:12px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--amber);font-family:'DM Mono',monospace;margin-bottom:4px">Research Area</div><div style="font-size:14px">${user.researchArea}</div></div>`:''}
</div>
<hr style="border:none;border-top:1px solid var(--border);margin:16px 0"/>
<div style="display:flex;gap:8px;flex-wrap:wrap">
  <button class="btn btn-primary" onclick="editProfile()" style="font-size:13px">âœï¸ Edit Profile</button>
  <button class="btn btn-ghost" onclick="closeProfile()" style="font-size:13px">Close</button>
  <button class="btn" onclick="doLogout()" style="background:none;border:1px solid var(--border);color:var(--muted);font-size:13px;border-radius:8px;padding:10px 16px;cursor:pointer">Sign Out</button>
</div>`;
  modal.classList.add('show');
}

function profileField(label, val) {
  if (!val) return '';
  return `<div style="background:var(--cream);border:1px solid var(--border);border-radius:7px;padding:10px 12px">
    <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:2px">${label}</div>
    <div style="font-size:13px;font-weight:600">${val}</div>
  </div>`;
}

function editProfile() {
  const user = getSession(); if (!user) return;
  const body = document.getElementById('profile-body');
  body.innerHTML = `
<div class="auth-row"><div class="auth-field"><label>First Name</label><input id="ep-first" value="${user.firstName||''}"></div>
<div class="auth-field"><label>Last Name</label><input id="ep-last" value="${user.lastName||''}"></div></div>
<div class="auth-row"><div class="auth-field"><label>Student Number</label><input id="ep-snum" value="${user.studentNum||''}"></div>
<div class="auth-field"><label>Email</label><input type="email" id="ep-email" value="${user.email||''}"></div></div>
<div class="auth-field"><label>Institution</label><input id="ep-inst" value="${user.institution||''}"></div>
<div class="auth-row"><div class="auth-field"><label>Programme</label>
<select id="ep-prog"><option>MEd Education</option><option>MEd Teaching & Learning</option><option>MEd Curriculum Studies</option><option>MEd Educational Leadership</option><option>MEd Inclusive Education</option><option>MEd TESOL / Language Education</option><option>Other Masters</option></select></div>
<div class="auth-field"><label>Year of Study</label>
<select id="ep-year"><option>Year 1 (Full-time)</option><option>Year 2 (Full-time)</option><option>Year 1 (Part-time)</option><option>Year 2 (Part-time)</option><option>Year 3 (Part-time)</option></select></div></div>
<div class="auth-field"><label>Supervisor Username</label><input id="ep-sup" value="${user.supervisorUsername||''}"></div>
<div class="auth-field"><label>Research Area</label><input id="ep-topic" value="${user.researchArea||''}"></div>
<div class="auth-row"><div class="auth-field"><label>Language</label>
<select id="ep-lang"><option>English</option><option>Afrikaans</option><option>Zulu</option><option>Xhosa</option><option>Sotho</option><option>French</option><option>Portuguese</option><option>Other</option></select></div>
<div class="auth-field"><label>New Password <span class="opt">(leave blank to keep)</span></label><input type="password" id="ep-pass" placeholder="New passwordâ€¦"></div></div>
<div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">
  <button class="btn btn-complete" onclick="saveProfile()" style="font-size:13px">ğŸ’¾ Save Changes</button>
  <button class="btn btn-ghost" onclick="openProfile()" style="font-size:13px">Cancel</button>
</div>`;
  ['ep-prog','ep-year','ep-lang'].forEach(id=>{
    const el=document.getElementById(id); const map={prog:user.programme,year:user.yearOfStudy,lang:user.language};
    const key=id.replace('ep-',''); if(map[key])for(let o of el.options){if(o.text===map[key]){o.selected=true;break;}}
  });
}

async function saveProfile() {
  const get = id => document.getElementById(id)?.value?.trim()||'';
  const session = getSession(); if (!session) return;
  const btn = document.querySelector('#profile-body .btn-complete');
  if (btn) { btn.disabled=true; btn.textContent='Savingâ€¦'; }
  const upd = {...session,
    firstName:   get('ep-first')||session.firstName,
    lastName:    get('ep-last')||session.lastName,
    studentNum:  get('ep-snum'), email:get('ep-email'), institution:get('ep-inst'),
    programme:   document.getElementById('ep-prog')?.value||session.programme,
    yearOfStudy: document.getElementById('ep-year')?.value||session.yearOfStudy,
    supervisorUsername:get('ep-sup'), researchArea:get('ep-topic'),
    language:    document.getElementById('ep-lang')?.value||session.language,
  };
  const np = get('ep-pass');
  if (FB_ON && session.uid) {
    const safe = {...upd}; delete safe.password;
    await fbSet(`users/${session.uid}`, safe);
    if (np && np.length >= 6) await FB_AUTH?.currentUser?.updatePassword(np);
    saveSession(safe);
  } else {
    saveSession(upd);
  }
  document.getElementById('student-name-chip').textContent = upd.firstName+' '+upd.lastName;
  document.getElementById('student-avatar').textContent = ((upd.firstName[0]||'')+(upd.lastName[0]||'')).toUpperCase();
  openProfile();
}

function closeProfile() { document.getElementById('profile-modal').classList.remove('show'); }
document.getElementById('profile-modal').addEventListener('click', function(e){ if(e.target===this) closeProfile(); });

// â”€â”€ Role selector on register form â”€â”€
function setRegRole(role) {
  document.getElementById('r-role').value = role;
  ['student','supervisor','lecturer'].forEach(r =>
    document.getElementById('role-opt-'+r).classList.toggle('active', r===role)
  );
  const isStu = role === 'student';
  document.getElementById('stu-only-fields').style.display = isStu ? '' : 'none';
  document.getElementById('sup-only-fields').style.display = isStu ? 'none' : '';
  const lbl = document.getElementById('r-id-label');
  if (lbl) lbl.textContent = isStu ? 'Student Number' : 'Staff / Employee Number';
  const inp = document.getElementById('r-snum');
  if (inp) inp.placeholder = isStu ? 'e.g. 2024001234' : 'e.g. EMP-0042';
  const btn = document.getElementById('r-submit');
  if (btn) btn.textContent = isStu ? 'Create Account & Begin â†’' : 'Create Supervisor Account â†’';
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIDEO CONFIG â€” swap these YouTube IDs as needed
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   All videos below are from the Grad Coach YouTube
   channel (@GradCoachAcademic) â€” highly recommended
   for dissertation support.

   To find the correct ID: go to the video on YouTube,
   copy the part after ?v= in the URL.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“¹  VIDEO CONFIGURATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOW TO UPDATE A VIDEO:
   1. Go to YouTube and find the video you want
   2. Copy the part after ?v= in the URL
      e.g. youtube.com/watch?v=SeGIBS6XEJA â†’ ID is SeGIBS6XEJA
   3. Replace the id value below for that module
   4. Update the title to match
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   All defaults below are from the Grad Coach YouTube channel
   (@GradCoachInternational) â€” excellent free dissertation support.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const VIDEOS = {
  // âœ… Confirmed IDs (verified from published sources)
  litreview:  { id: 'SeGIBS6XEJA', title: 'How To Write A Literature Review â€” Grad Coach' },

  // ğŸ“‹ Best-match IDs â€” verify by visiting the link and checking the title
  // youtube.com/watch?v=[ID]
  overview:      { id: 'oa8yhfpHPIk', title: 'How To Write A Dissertation â€” Grad Coach' },
  proposal:      { id: '7_VkRMvGo48', title: 'How To Write A Research Proposal â€” Grad Coach' },
  introduction:  { id: 'Fj5yQlM9xws', title: 'How To Write The Introduction Chapter â€” Grad Coach' },
  methodology:   { id: 'uCNFRpd_p5k', title: 'Research Methodology Explained â€” Grad Coach' },
  ethics:        { id: 'SHKisMVlC0Q', title: 'Research Ethics Explained â€” Grad Coach' },
  datacoll:      { id: 'AbE8ZlnMnDI', title: 'Qualitative Data Collection Methods â€” Grad Coach' },
  analysis:      { id: 'DRL4Jo1nuP0', title: 'Thematic Analysis Step By Step â€” Grad Coach' },
  writingup:     { id: 'pGZEiS21BKs', title: 'How To Write The Discussion Chapter â€” Grad Coach' },
  submission:    { id: 'X3Ow4j3pOfg', title: 'Dissertation Submission Checklist â€” Grad Coach' },
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIDEO CONFIGS  â€” chapters, timed interactions, AI context
   Adjust `time` values (seconds) to match your actual videos.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const VC = {
  overview: {
    chapters:[{t:0,n:'Introduction'},{t:90,n:'What is a Dissertation?'},{t:240,n:'Research Process'},{t:420,n:'Chapter Structure'},{t:600,n:'Timeline & Planning'}],
    ix:[
      {id:'ov1',t:200,type:'mcq',q:'What are the four key steps of the research process?',
       opts:['Plan, Write, Edit, Submit','Ask, Review, Investigate, Report','Research, Analyse, Discuss, Conclude','Propose, Collect, Analyse, Write'],
       ok:1,fb:'âœ… Correct. The research process: Ask a focused question â†’ Review what others have found â†’ Investigate through your own study â†’ Report your findings. Every chapter of your dissertation maps to one of these steps.'},
      {id:'ov2',t:500,type:'refl',q:'Which aspect of writing a dissertation concerns you most at this stage?',ph:'Be honest â€” there are no wrong answers. This helps you identify where to focusâ€¦'}
    ],
    ctx:'Overview of how to write a Masters dissertation: the four-step research process (ask, review, investigate, report), standard chapter structure (introduction, literature review, methodology, findings, discussion, conclusion), and practical advice for managing the process from proposal to submission.'
  },
  proposal: {
    chapters:[{t:0,n:'What is a Proposal?'},{t:120,n:'Core Components'},{t:300,n:'Research Questions'},{t:480,n:'Methodology Overview'},{t:630,n:'Making it Convincing'}],
    ix:[
      {id:'pr1',t:180,type:'mcq',q:'A research proposal must convince the reader of two things. What are they?',
       opts:['The research is interesting AND the student is knowledgeable','The research is worth doing AND it is feasible within the timeframe','A literature gap exists AND the methodology is advanced','The topic is original AND the student can write well'],
       ok:1,fb:'âœ… Exactly right. Every argument in your proposal serves one of two purposes: showing the research is valuable (worth doing) or showing it can actually be completed (feasible). Both must be demonstrated.'},
      {id:'pr2',t:540,type:'refl',q:'Write a one-paragraph elevator pitch for your research â€” what you plan to investigate, why it matters, and how you will do it.',ph:'Your elevator pitch (3â€“5 sentences)â€¦'}
    ],
    ctx:'How to write a research proposal for a Masters dissertation. Core components: working title, problem statement and rationale, brief literature context, methodology overview, significance and contribution. Key principle: the proposal is an argument that the research is both worth doing and doable.'
  },
  introduction: {
    chapters:[{t:0,n:'Purpose of Ch.1'},{t:90,n:'Background & Context'},{t:240,n:'Problem Statement'},{t:420,n:'Research Questions'},{t:570,n:'Chapter Outline'}],
    ix:[
      {id:'in1',t:160,type:'mcq',q:'Which metaphor best describes the structure of a dissertation introduction?',
       opts:['A ladder â€” from specific to broad','A funnel â€” from broad context to focused research questions','A circle â€” returning to the starting point','A table â€” parallel ideas side by side'],
       ok:1,fb:'âœ… The funnel structure: begin with broad educational/policy context, narrow progressively to the specific problem, then arrive at your focused research questions. This guides the reader logically to your study.'},
      {id:'in2',t:480,type:'refl',q:'Draft your research problem statement in 2â€“3 sentences: What is the gap or issue? Why does it matter? Who is affected?',ph:'Despiteâ€¦ [what exists], [the specific problem remains]. This matters becauseâ€¦ This study therefore investigatesâ€¦'}
    ],
    ctx:'How to write the introduction chapter (Chapter 1) of a dissertation. Topics: funnel structure (broad to specific), establishing background and context, writing a focused problem statement, positioning research questions, articulating significance and rationale, and ending with a chapter outline. Common mistakes: starting too broadly, vague problem statements, burying research questions.'
  },
  litreview: {
    chapters:[{t:0,n:'What is a Lit Review?'},{t:120,n:'Finding Literature'},{t:300,n:'Organising Sources'},{t:480,n:'Writing the Review'},{t:650,n:'Common Mistakes'}],
    ix:[
      {id:'lr1',t:220,type:'mcq',q:'What is the key difference between summarising and synthesising literature?',
       opts:['Summarising is shorter; synthesising is longer','Summarising describes each source separately; synthesising integrates sources around ideas to build an argument','Summarising is for journals; synthesising is for books','There is no meaningful difference'],
       ok:1,fb:'âœ… Correct. Summarising describes each source in turn. Synthesising integrates sources around themes and builds a critical argument. At Masters level, examiners expect synthesis â€” not an annotated bibliography.'},
      {id:'lr2',t:520,type:'refl',q:'What is the main thematic argument you want your literature review to make? What scholarly conversation are you entering?',ph:'My literature review argues thatâ€¦ by showingâ€¦'}
    ],
    ctx:'How to write a literature review. Three-step process: (1) find and catalogue using ERIC, Google Scholar, Boolean searches; (2) plan thematically â€” not source by source; (3) write using synthesis (integrating sources around ideas) not summary (describing each source separately). The review should position the study by showing what is known, what is debated, and where the gap lies.'
  },
  methodology: {
    chapters:[{t:0,n:'What is Methodology?'},{t:120,n:'Research Paradigms'},{t:300,n:'Qualitative vs Quantitative'},{t:480,n:'Research Designs'},{t:660,n:'Justifying Choices'}],
    ix:[
      {id:'me1',t:200,type:'mcq',q:'What is the difference between a research method and a methodology?',
       opts:['They mean the same thing','A method is a specific data collection tool; methodology is the philosophical framework justifying your entire research design','Methodology is for qualitative; methods are for quantitative','A method is theoretical; methodology is practical'],
       ok:1,fb:'âœ… Correct. Methods are specific tools (interviews, surveys). Methodology is the broader framework â€” paradigm, design, and rationale â€” that explains why your chosen methods are the right ones for your research questions.'},
      {id:'me2',t:500,type:'refl',q:'What research paradigm underpins your study (interpretivist, positivist, critical)? What does this mean for how you understand knowledge in your research context?',ph:'My study adopts anâ€¦ paradigm becauseâ€¦'}
    ],
    ctx:'Research methodology for dissertation students. Key distinctions: method vs methodology, research paradigms (positivism â€” objective measurable reality; interpretivism â€” socially constructed meaning; critical/transformative â€” challenging power structures), qualitative vs quantitative vs mixed methods, common designs (case study, survey, action research, ethnography), and how to justify all methodological choices with reference to philosophical grounding and research questions.'
  },
  ethics: {
    chapters:[{t:0,n:'Why Research Ethics?'},{t:120,n:'Core Principles'},{t:280,n:'Consent & Confidentiality'},{t:440,n:'Ethics Applications'},{t:580,n:'Power & Access'}],
    ix:[
      {id:'et1',t:200,type:'mcq',q:'A teacher-researcher wants to interview their own current students. What is the PRIMARY ethical concern?',
       opts:['Students may lack relevant knowledge','Interviews may take too long','The power relationship means participation cannot be truly voluntary','Anonymity is difficult in school settings'],
       ok:2,fb:'âœ… Correct. The power dynamic is the primary concern: students may feel unable to refuse participation or may alter answers to please their teacher. This compromises voluntary participation â€” one of the most fundamental ethical principles in research.'},
      {id:'et2',t:460,type:'refl',q:'Identify one specific ethical risk in your own planned research and describe exactly how you will manage it.',ph:'The ethical risk in my study isâ€¦ I will manage this byâ€¦'}
    ],
    ctx:'Research ethics for dissertation students. Four core principles: informed consent, confidentiality and anonymity, voluntary participation, do no harm. Covers: writing informed consent forms in plain language, working with minors, ethics application process (must be approved before any data collection â€” allow 4â€“6 weeks), power dynamics between researcher and participants, and data storage and security requirements.'
  },
  datacoll: {
    chapters:[{t:0,n:'Overview of Methods'},{t:120,n:'Interviews'},{t:300,n:'Focus Groups'},{t:460,n:'Observation'},{t:620,n:'Piloting & Quality'}],
    ix:[
      {id:'dc1',t:220,type:'mcq',q:'In a semi-structured interview, what does "semi-structured" mean?',
       opts:['Conducted online rather than in person','A prepared guide with key questions, but the interviewer can probe and follow up flexibly','Questions are prepared but participants answer in writing','Half the questions are open and half are closed'],
       ok:1,fb:'âœ… Correct. Semi-structured means a prepared guide ensures consistency across participants, while flexibility allows the interviewer to probe, follow up, and let important threads develop naturally. This balance is ideal for education research.'},
      {id:'dc2',t:480,type:'refl',q:'How will you build rapport and trust with your participants before and during data collection? What specific practical steps will you take?',ph:'My approach to building participant rapport and trustâ€¦'}
    ],
    ctx:'Qualitative data collection methods for education research. Methods explained: semi-structured interviews (most common â€” prepared guide, open questions, 45â€“90 mins, recorded with consent), focus groups (4â€“8 participants, good for shared experiences), observation (participant or non-participant, systematic field notes), document analysis (policies, lesson plans, student work). Also covers: interview guide design, piloting instruments, and building rapport.'
  },
  analysis: {
    chapters:[{t:0,n:'Introduction to TA'},{t:90,n:'Phases 1â€“2: Familiarise & Code'},{t:260,n:'Phases 3â€“4: Themes'},{t:430,n:'Phases 5â€“6: Define & Write'},{t:600,n:'Rigour & Trustworthiness'}],
    ix:[
      {id:'an1',t:170,type:'mcq',q:'In thematic analysis, what is the difference between a code and a theme?',
       opts:['Codes are broader; themes are more specific','Codes are labels applied to data segments; themes are broader patterns that emerge from grouped codes','They are the same thing â€” interchangeable terms','Codes are for quantitative; themes are qualitative'],
       ok:1,fb:'âœ… Correct. Codes are labels for specific data segments â€” they capture what is interesting in a small piece of text. Themes are broader, more abstract patterns that emerge when you group and interpret related codes across the whole dataset.'},
      {id:'an2',t:460,type:'refl',q:'After your initial familiarisation with your data, what is one unexpected pattern or finding that has emerged? What might it mean?',ph:'Something I didn\'t expect to find in my data isâ€¦ This might meanâ€¦'}
    ],
    ctx:'Thematic analysis (Braun and Clarke\'s 6-phase approach). Phase 1: familiarise â€” read and re-read data. Phase 2: initial coding â€” systematically label interesting features. Phase 3: searching for themes â€” collate codes into potential themes. Phase 4: reviewing themes â€” check against full dataset. Phase 5: defining and naming â€” clearly articulate each theme. Phase 6: writing up â€” produce analytical report with evidence. Also covers: difference between codes and themes, analytical interpretation vs description, and establishing rigour (credibility, transferability, dependability, confirmability).'
  },
  writingup: {
    chapters:[{t:0,n:'Discussion vs Findings'},{t:120,n:'Structuring Discussion'},{t:300,n:'Connecting to Literature'},{t:480,n:'Academic Voice'},{t:620,n:'Writing the Conclusion'}],
    ix:[
      {id:'wu1',t:200,type:'mcq',q:'What is the MAIN difference between a findings chapter and a discussion chapter?',
       opts:['Findings use data; discussion uses theory','Findings are shorter; discussion is longer','Findings present what you found; discussion interprets what it means in relation to literature and theory','Findings are qualitative; discussion is quantitative'],
       ok:2,fb:'âœ… Correct. The findings chapter presents your data thematically â€” what you found. The discussion interprets: what does it mean? How does it connect to existing literature? What are the theoretical and practical implications? Your researcher voice is strongest in the discussion.'},
      {id:'wu2',t:520,type:'refl',q:'What is the most significant contribution your dissertation makes to educational knowledge or practice? State it as clearly and confidently as possible.',ph:'My dissertation contributes to educational knowledge byâ€¦'}
    ],
    ctx:'How to write the discussion chapter and conclusion. Key distinction: findings present data, discussion interprets meaning. Discussion structure: connect findings to literature (confirming, extending or challenging), incorporate theoretical framework, use authoritative academic voice with appropriate hedging. Conclusion covers: summary of key findings, implications for practice and policy, limitations (specific, not generic apologies), and future research directions.'
  },
  submission: {
    chapters:[{t:0,n:'Final Preparation'},{t:120,n:'Content Review'},{t:280,n:'Formatting'},{t:420,n:'Proofreading'},{t:540,n:'Submission Process'}],
    ix:[
      {id:'su1',t:200,type:'mcq',q:'What should you do BEFORE submitting your dissertation?',
       opts:['Re-read the entire dissertation in one sitting','Check the Turnitin similarity score and review with your supervisor','Print a physical copy for your records','Submit one chapter at a time to test the system'],
       ok:1,fb:'âœ… Correct. A Turnitin/similarity check reviewed with your supervisor is a standard required step â€” it ensures academic integrity and gives your supervisor a final opportunity to flag concerns before you submit.'},
      {id:'su2',t:450,type:'refl',q:'Looking back from proposal to near-submission: what is the most important thing you have learned about yourself as a researcher?',ph:'The most important thing I\'ve learned about myself as a researcher isâ€¦'}
    ],
    ctx:'Dissertation submission preparation. Covers: content review checklist (all research questions answered, chapters complete, ethics referenced), formatting requirements (title page, abstract, table of contents, consistent style, reference list in required format), proofreading strategies (reading aloud, peer review), Turnitin similarity checks, supervisor sign-off, file format (PDF), backup strategies, and the submission portal process.'
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI FEEDBACK ENGINE
   Calls the Anthropic API to give supervisor-style
   feedback on student writing exercises.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function getAIFeedback(exerciseId, exerciseContext, studentText) {
  const fbEl = document.getElementById('fb-' + exerciseId);
  const btn  = document.getElementById('ai-btn-' + exerciseId);
  if (!studentText || studentText.trim().length < 30) {
    showFeedback(fbEl, `<p>Please write at least a few sentences before requesting feedback.</p>`);
    return;
  }
  btn.disabled = true;
  fbEl.className = 'ai-feedback show';
  fbEl.innerHTML = `<div class="ai-feedback-header"><div class="ai-feedback-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg></div><div class="ai-feedback-title">AI Supervisor Feedback</div></div><div class="ai-loading"><div class="spinner"></div>Analysing your writingâ€¦</div>`;

  const systemPrompt = `You are a senior dissertation supervisor in the Faculty of Education at a research-intensive university. You are reviewing a Masters student's written exercise as part of their MEd dissertation unit. Your role is to provide full, detailed, supervisor-style written feedback â€” the kind of feedback a student would receive from a thorough supervisor review, not a brief comment.

Your feedback must:

1. Be structured in three clearly labelled sections:
   âœ… STRENGTHS â€” What the student has done well, with specific reference to their actual words or ideas. Be genuinely specific, not generic praise.
   ğŸ”§ AREAS TO DEVELOP â€” Where the work falls short of Masters-level expectations. Reference specific passages or gaps. Be direct but constructive.
   ğŸ’¡ SPECIFIC SUGGESTIONS â€” Concrete, actionable steps the student can take to improve this specific piece of writing. Include example phrases or structural suggestions where helpful.

2. Reference MEd/Masters-level dissertation marking criteria throughout, including:
   - Clarity, focus and specificity of argument
   - Academic language and register
   - Evidence of critical thinking (not just description)
   - Alignment with research questions and dissertation purpose
   - Appropriate use of academic literature or methodology conventions (where relevant to the exercise)
   - Originality and analytical depth

3. Be written in full paragraphs within each section â€” not bullet point lists within the sections
4. Quote or paraphrase the student's actual writing at least twice to make feedback feel personal and specific
5. Be 300â€“450 words total â€” detailed enough to be genuinely useful, not so long it overwhelms
6. End with a single encouraging sentence that acknowledges the student's progress

The exercise context is: ${exerciseContext}

IMPORTANT: Do NOT write the student's work for them. Do NOT provide model answers. Coach and guide only. If the response is very short or underdeveloped, acknowledge this and explain what is missing rather than inferring content.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: [{ role: 'user', content: `Please give me supervisor feedback on this exercise response:\n\n"${studentText}"` }]
      })
    });
    const data = await res.json();
    const text = data.content?.map(c => c.text || '').join('') || 'Unable to generate feedback.';
    showFeedback(fbEl, formatFeedback(text));
  } catch(e) {
    showFeedback(fbEl, `<p style="color:var(--red)">Feedback service unavailable. Please try again shortly.</p>`);
  }
  btn.disabled = false;
}

function formatFeedback(text) {
  // Convert markdown-style to HTML
  let html = text
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/âœ…\s*/g, '<br/><strong style="color:var(--green)">âœ… Strengths</strong><br/>')
    .replace(/ğŸ”§\s*/g, '<br/><strong style="color:var(--amber)">ğŸ”§ Areas to Develop</strong><br/>')
    .replace(/ğŸ’¡\s*/g, '<br/><strong style="color:var(--purple)">ğŸ’¡ Specific Suggestions</strong><br/>')
    .replace(/\n\n/g, '<br/><br/>')
    .replace(/\n/g, '<br/>');
  return `<div class="ai-feedback-header">
    <div class="ai-feedback-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></div>
    <div class="ai-feedback-title">AI Supervisor Feedback</div>
  </div>
  <div class="ai-feedback-body">${html}</div>`;
}

function showFeedback(el, html) {
  el.className = 'ai-feedback show';
  el.innerHTML = html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   YOUTUBE API â€” load once, queue players
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function(){const s=document.createElement('script');s.src='https://www.youtube.com/iframe_api';document.head.appendChild(s);})();
window._ytQ=[]; window._ytOK=false;
window.onYouTubeIframeAPIReady=function(){window._ytOK=true;window._ytQ.forEach(f=>f());window._ytQ=[];};
let _activeIVP=null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INTERACTIVE VIDEO PLAYER CLASS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
class InteractiveVideoPlayer {
  constructor(cid, key) {
    this.cid=cid; this.key=key;
    this.vcfg=VC[key]||{chapters:[],ix:[],ctx:''};
    this.vmeta=VIDEOS[key];
    this.player=null; this.timer=null;
    this.done=new Set(); this.chatHist=[];
    this.chatOn=false; this.dur=600; this.t=0;
    this._render();
    this._initYT();
    window['_ivp_'+cid]=this;
    if(_activeIVP&&_activeIVP!==this) _activeIVP.destroy();
    _activeIVP=this;
  }

  _render() {
    const el=document.getElementById(this.cid); if(!el) return;
    const ttl=this.vmeta?this.vmeta.title:'';
    el.innerHTML=`
<div class="ivp">
  <div class="ivp-head">
    <svg width="11" height="11" viewBox="0 0 24 24" fill="rgba(255,255,255,0.5)" stroke="none"><polygon points="5 3 19 12 5 21"/></svg>
    <span class="ivp-label">Watch</span>
    <span class="ivp-vid-title">${ttl}</span>
    <button class="ivp-ibtn" id="ctbtn-${this.cid}" onclick="_ivp_${this.cid}.toggleChat()">ğŸ¤– AI Chat</button>
  </div>
  <div class="ivp-body" id="ibody-${this.cid}">
    <div class="ivp-vcol">
      <div class="ivp-wrap">
        <div id="yt-${this.cid}"></div>
        <div class="ivp-overlay" id="ovl-${this.cid}"></div>
      </div>
      <div class="ivp-chbar">
        <div class="ivp-track" id="trk-${this.cid}" onclick="_ivp_${this.cid}._seekTrack(event)">
          <div class="ivp-fill" id="fill-${this.cid}"></div>
        </div>
        <div class="ivp-ch-lbls" id="chlbls-${this.cid}"></div>
      </div>
    </div>
    <div class="ivp-chat" id="chat-${this.cid}" style="display:none">
      <div class="ivp-chat-hd">
        <span style="font-size:16px">ğŸ¤–</span>
        <span class="ivp-chat-hd-ttl">AI Video Tutor</span>
        <span class="sub">Ask anything</span>
      </div>
      <div class="ivp-msgs" id="msgs-${this.cid}">
        <div class="ivp-msg ai">ğŸ‘‹ I know this video's content. Ask me anything â€” concepts, how it applies to your dissertation, or anything you'd like to explore further.</div>
      </div>
      <div class="ivp-chat-inp-row">
        <textarea class="ivp-chat-ta" id="cta-${this.cid}" placeholder="Ask about the videoâ€¦" rows="2" onkeydown="_ivp_${this.cid}._ckd(event)"></textarea>
        <button class="ivp-chat-send" id="csnd-${this.cid}" onclick="_ivp_${this.cid}.sendChat()">â¤</button>
      </div>
    </div>
  </div>
</div>`;
    this._buildChLabels();
  }

  _buildChLabels() {
    const lbl=document.getElementById('chlbls-'+this.cid); if(!lbl) return;
    lbl.innerHTML=this.vcfg.chapters.map((c,i)=>
      `<span class="ivp-ch-l" id="cl-${this.cid}-${i}" onclick="_ivp_${this.cid}.seekTo(${c.t})">${c.n}</span>`
    ).join('');
  }

  _addMarkers() {
    const trk=document.getElementById('trk-'+this.cid); if(!trk||!this.dur) return;
    this.vcfg.chapters.forEach((c,i)=>{
      if(i===0) return;
      const d=document.createElement('div');
      d.className='ivp-mkr'; d.id='mkr-'+this.cid+'-'+i;
      d.style.left=(c.t/this.dur*100)+'%';
      d.innerHTML=`<span class="ch-tip">${c.n}</span>`;
      d.onclick=(e)=>{e.stopPropagation();this.seekTo(c.t);};
      trk.appendChild(d);
    });
  }

  _initYT() {
    const go=()=>{
      if(!this.vmeta) return;
      const wrap=document.getElementById('yt-'+this.cid);
      const w=wrap?wrap.parentElement.offsetWidth||640:640;
      const h=Math.round(w*9/16);
      this.player=new YT.Player('yt-'+this.cid,{
        videoId:this.vmeta.id, width:w, height:h,
        playerVars:{rel:0,modestbranding:1,enablejsapi:1},
        events:{onReady:()=>this._ready()}
      });
    };
    if(window._ytOK) go(); else window._ytQ.push(go);
  }

  _ready() {
    this.dur=this.player.getDuration()||600;
    this._addMarkers();
    this.timer=setInterval(()=>this._tick(),600);
  }

  _tick() {
    if(!this.player||!this.player.getCurrentTime) return;
    this.t=Math.floor(this.player.getCurrentTime());
    this.dur=this.player.getDuration()||this.dur;
    // progress bar
    const f=document.getElementById('fill-'+this.cid);
    if(f) f.style.width=(this.t/this.dur*100)+'%';
    // chapter highlight
    let ci=0;
    this.vcfg.chapters.forEach((c,i)=>{if(this.t>=c.t) ci=i;});
    document.querySelectorAll('[id^="cl-'+this.cid+'-"]').forEach((el,i)=>el.classList.toggle('on',i===ci));
    document.querySelectorAll('[id^="mkr-'+this.cid+'-"]').forEach((el,i)=>el.classList.toggle('on',i+1===ci));
    // interactions
    this.vcfg.ix.forEach(x=>{
      if(this.done.has(x.id)) return;
      const d=this.t-x.t;
      if(d>=0&&d<4){this.done.add(x.id);this._showIX(x);}
    });
  }

  _showIX(x) {
    if(this.player) this.player.pauseVideo();
    const ovl=document.getElementById('ovl-'+this.cid); if(!ovl) return;
    const ts=this._fmt(x.t);
    let inner='';
    if(x.type==='mcq'){
      const L=['A','B','C','D'];
      inner=`<p class="ivp-time-tag">â¸ Paused at ${ts}</p>
<div class="ivp-card-tag mcq">Quick Check</div>
<p class="ivp-card-q">${x.q}</p>
<div class="ivp-opts">${x.opts.map((o,i)=>`<div class="ivp-opt" id="oo-${this.cid}-${i}" onclick="_ivp_${this.cid}._pick(${i},${x.ok},'${x.id}',\`${x.fb.replace(/`/g,"'")}\`)"><span class="ivp-let">${L[i]}</span><span>${o}</span></div>`).join('')}</div>
<div class="ivp-cfb" id="cfb-${this.cid}"></div>
<div class="ivp-cbtns"><button class="ivp-skip-btn" onclick="_ivp_${this.cid}.resume()">Skip & Resume â–¶</button></div>`;
    } else {
      inner=`<p class="ivp-time-tag">â¸ Paused at ${ts}</p>
<div class="ivp-card-tag refl">Reflection</div>
<p class="ivp-card-q">${x.q}</p>
<textarea id="ivta-${this.cid}" rows="4" placeholder="${(x.ph||'').replace(/"/g,"'")}"></textarea>
<div class="ivp-cbtns">
  <button class="ivp-go" onclick="_ivp_${this.cid}._saveRefl('${x.id}',\`${x.q.replace(/`/g,"'")}\`)">ğŸ’¾ Save & Resume â–¶</button>
  <button class="ivp-skip-btn" onclick="_ivp_${this.cid}.resume()">Skip â–¶</button>
</div>`;
    }
    ovl.innerHTML=`<div class="ivp-card">${inner}</div>`;
    ovl.classList.add('show');
  }

  _pick(chosen,ok,xid,fb) {
    document.querySelectorAll('[id^="oo-'+this.cid+'-"]').forEach((el,i)=>{
      el.classList.add('locked');
      if(i===ok) el.classList.add('correct');
      else if(i===chosen) el.classList.add('wrong');
    });
    const f=document.getElementById('cfb-'+this.cid);
    if(f){f.className='ivp-cfb show '+(chosen===ok?'ok':'err');f.innerHTML=fb;}
    _rec(this.key,xid,'mcq',this.vcfg.ix.find(x=>x.id===xid)?.q||'',chosen===ok?'Correct (option '+chosen+')':'Wrong (option '+chosen+')',chosen===ok,this.t);
    setTimeout(()=>this.resume(),3500);
  }

  _saveRefl(xid,q) {
    const ta=document.getElementById('ivta-'+this.cid);
    const txt=ta?ta.value.trim():'';
    _rec(this.key,xid,'reflection',q,txt,null,this.t);
    this.resume();
  }

  resume() {
    const o=document.getElementById('ovl-'+this.cid);
    if(o) o.classList.remove('show');
    if(this.player) this.player.playVideo();
  }

  seekTo(s){if(this.player&&this.player.seekTo) this.player.seekTo(s,true);}
  _seekTrack(e){
    const trk=document.getElementById('trk-'+this.cid); if(!trk||!this.dur) return;
    const r=trk.getBoundingClientRect();
    this.seekTo(Math.floor(((e.clientX-r.left)/r.width)*this.dur));
  }

  toggleChat(){
    this.chatOn=!this.chatOn;
    const p=document.getElementById('chat-'+this.cid);
    const btn=document.getElementById('ctbtn-'+this.cid);
    if(p){ p.style.display=this.chatOn?'flex':'none'; if(this.chatOn) p.style.flexDirection='column'; }
    if(btn) btn.classList.toggle('on',this.chatOn);
    if(this.chatOn) setTimeout(()=>{ const msgs=document.getElementById('msgs-'+this.cid); if(msgs) msgs.scrollTop=msgs.scrollHeight; },50);
  }

  _ckd(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();this.sendChat();}}

  async sendChat(){
    const ta=document.getElementById('cta-'+this.cid);
    const snd=document.getElementById('csnd-'+this.cid);
    const msgs=document.getElementById('msgs-'+this.cid);
    const txt=ta?ta.value.trim():''; if(!txt) return;
    ta.value='';
    msgs.innerHTML+=`<div class="ivp-msg usr">${txt.replace(/</g,'&lt;')}</div>`;
    const lid='l'+Date.now();
    msgs.innerHTML+=`<div class="ivp-msg ai" id="${lid}"><div class="ai-loading"><div class="spinner" style="border-color:rgba(255,255,255,0.1);border-top-color:#a78bfa;width:14px;height:14px"></div>Thinkingâ€¦</div></div>`;
    msgs.scrollTop=msgs.scrollHeight; snd.disabled=true;
    this.chatHist.push({role:'user',content:txt});
    let curCh=''; for(const c of this.vcfg.chapters){if(this.t>=c.t) curCh=c.n;}
    const sys=`You are an expert AI tutor embedded in an MEd dissertation unit. The student is watching: "${this.vmeta?.title||''}", currently in chapter "${curCh}".

VIDEO CONTENT:
${this.vcfg.ctx}

YOUR ROLE: Answer questions about this video's content, help the student apply concepts to their own dissertation, probe understanding with follow-up questions. Keep responses focused (2â€“4 sentences unless more is genuinely needed). Be warm and encouraging.`;
    try {
      const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:800,system:sys,messages:this.chatHist.slice(-8)})});
      const data=await res.json();
      const reply=data.content?.map(c=>c.text||'').join('')||'Sorry, could not process that. Please try again.';
      this.chatHist.push({role:'assistant',content:reply});
      const le=document.getElementById(lid);
      if(le) le.innerHTML=reply.replace(/\n/g,'<br>').replace(/</g,'&lt;').replace(/&lt;br>/g,'<br>');
    } catch(e){
      const le=document.getElementById(lid); if(le) le.innerHTML='Connection issue â€” please try again.';
    }
    snd.disabled=false; msgs.scrollTop=msgs.scrollHeight;
  }

  _fmt(s){return Math.floor(s/60)+':'+(s%60).toString().padStart(2,'0');}
  destroy(){clearInterval(this.timer);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA COLLECTION
   Responses stored in localStorage, exportable CSV
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _getSid(){
  const s = getSession();
  if (s) return s.username;
  // Fallback for unauthenticated (shouldn't happen)
  let id=localStorage.getItem('diss-sid');
  if(!id){id='S'+Date.now().toString(36).toUpperCase().slice(-4)+Math.random().toString(36).slice(2,5).toUpperCase();localStorage.setItem('diss-sid',id);}
  return id;
}
function _loadR(){try{return JSON.parse(localStorage.getItem('diss-vr')||'[]');}catch(e){return[];}}
function _saveR(a){try{localStorage.setItem('diss-vr',JSON.stringify(a));}catch(e){}}
function _rec(vkey,xid,type,q,ans,correct,vt){
  const s = getSession()||{};
  const e={
    username:  s.username||'unknown',
    firstName: s.firstName||'', lastName: s.lastName||'',
    studentNum:s.studentNum||'', institution:s.institution||'',
    programme: s.programme||'', yearOfStudy:s.yearOfStudy||'',
    supervisor:s.supervisor||'', researchArea:s.researchArea||'',
    language:  s.language||'',
    video:vkey, xid, type, q, ans:String(ans), correct, vt,
    ts:new Date().toISOString()
  };
  const a=_loadR(); a.push(e); _saveR(a);
  if (FB_ON && s.uid) fbPush(`studentData/${s.uid}/videoResponses`, e);
}
function exportCSV(){
  const d=_loadR(); if(!d.length){alert('No responses recorded yet.');return;}
  const h=['Username','First Name','Last Name','Student Number','Institution','Programme','Year','Supervisor','Research Area','Language','Video','Interaction','Type','Question','Answer','Correct','Video Time (s)','Timestamp'];
  const rows=d.map(r=>[
    r.username,r.firstName,r.lastName,r.studentNum,
    '"'+(r.institution||'').replace(/"/g,'""')+'"',
    '"'+(r.programme||'').replace(/"/g,'""')+'"',
    '"'+(r.yearOfStudy||'').replace(/"/g,'""')+'"',
    '"'+(r.supervisor||'').replace(/"/g,'""')+'"',
    '"'+(r.researchArea||'').replace(/"/g,'""')+'"',
    r.language,
    r.video,r.xid,r.type,
    '"'+r.q.replace(/"/g,'""')+'"',
    '"'+r.ans.replace(/"/g,'""')+'"',
    r.correct===null?'n/a':r.correct,r.vt,r.ts
  ].join(','));
  const csv=[h.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='video-responses-'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();
}
function clearVData(){if(confirm('Clear all your saved video responses?')){localStorage.removeItem('diss-vr');renderDash();}}
function renderDash(){
  const el=document.getElementById('data-dash'); if(!el) return;
  const sid=_getSid(); const all=_loadR(); const mine=all.filter(r=>r.username===sid);
  const s = getSession()||{};
  const displayName = s.firstName ? `${s.firstName} ${s.lastName}` : sid;
  const mcqs=mine.filter(r=>r.type==='mcq'); const ok=mcqs.filter(r=>r.correct===true).length;
  const refls=mine.filter(r=>r.type==='reflection'); const vids=[...new Set(mine.map(r=>r.video))].length;
  let rows=''; mine.slice().reverse().slice(0,20).forEach(r=>{
    rows+=`<tr><td style="font-family:'DM Mono',monospace;font-size:11px">${r.video}</td>
<td><span class="dtype ${r.type}">${r.type}</span></td>
<td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${r.q.replace(/"/g,'')}">${r.q.slice(0,55)}${r.q.length>55?'â€¦':''}</td>
<td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.ans.slice(0,45)}${r.ans.length>45?'â€¦':''}</td>
<td>${r.correct===null?'â€”':r.correct?'<span style="color:var(--green)">âœ“</span>':'<span style="color:var(--red)">âœ—</span>'}</td></tr>`;
  });
  el.innerHTML=`
<div class="data-stat-grid">
  <div class="data-stat"><div class="data-stat-n">${mine.length}</div><div class="data-stat-l">Responses</div></div>
  <div class="data-stat"><div class="data-stat-n">${vids}</div><div class="data-stat-l">Videos Done</div></div>
  <div class="data-stat"><div class="data-stat-n">${ok}/${mcqs.length||0}</div><div class="data-stat-l">Quiz Score</div></div>
  <div class="data-stat"><div class="data-stat-n">${refls.length}</div><div class="data-stat-l">Reflections</div></div>
</div>
<p style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:8px">
  Signed in as: <strong>${displayName}</strong> Â· ${s.studentNum||sid} Â· ${s.institution||''} Â· 
  <span onclick="openProfile()" style="color:var(--amber);cursor:pointer;text-decoration:underline">Edit profile</span>
</p>
${mine.length?`<table class="data-tbl"><thead><tr><th>Video</th><th>Type</th><th>Question</th><th>Answer</th><th>âœ“</th></tr></thead><tbody>${rows}</tbody></table>`:'<p style="color:var(--muted);font-style:italic;font-size:14px">Complete video interactions to see your data here.</p>'}
<div class="btn-row" style="margin-top:14px">
  <button class="btn btn-primary" onclick="exportCSV()">â¬‡ Export My Data (CSV)</button>
  <button class="btn btn-ghost" onclick="clearVData()">ğŸ—‘ Clear</button>
</div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HTML HELPERS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function vid(key) {
  const divId = 'ivp-' + key + '-' + Date.now();
  // Launch interactive player after DOM renders
  setTimeout(() => {
    if (document.getElementById(divId)) new InteractiveVideoPlayer(divId, key);
  }, 80);
  return `<div id="${divId}"></div>`;
}

function ex(id, label, hint, aiFeedback, aiContext, height=110) {
  const saved = ls(id) || '';
  const aiBtn = aiFeedback ? `<button class="btn btn-ai" id="ai-btn-${id}" onclick="getAIFeedback('${id}','${(aiContext||'').replace(/'/g,"\\'")}',document.getElementById('${id}').value)">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
    Get AI Feedback
  </button>` : '';
  return `<div style="margin-bottom:16px">
    <p class="ex-lbl">${label}</p>
    ${hint?`<p class="ex-hint">${hint}</p>`:''}
    <textarea class="ex-input" id="${id}" style="min-height:${height}px" placeholder="Write your response hereâ€¦" onchange="sv('${id}')">${saved}</textarea>
    <div class="btn-row">
      <button class="btn btn-save" id="sv-${id}" onclick="sv('${id}',true)">ğŸ’¾ Save</button>
      ${aiBtn}
    </div>
    ${aiFeedback?`<div class="ai-feedback" id="fb-${id}"></div>`:''}
  </div>`;
}

function mcq(id, q, opts, correct, fb) {
  const letters=['A','B','C','D'];
  const saved = ls('mcq-'+id);
  let html = opts.map((o,i)=>{
    let cls='mcq-opt'+(saved!==null?(i===correct?' correct':(i===parseInt(saved)?' wrong':''))+' disabled':'');
    return `<div class="${cls}" id="${id}-o${i}" onclick="pickMcq('${id}',${i},${correct},'${id}-fb')">
      <div class="mcq-letter">${letters[i]}</div><span>${o}</span></div>`;
  }).join('');
  const fbCls=saved!==null?(parseInt(saved)===correct?'correct':'wrong'):'';
  return `<div class="mcq-block">
    <p class="mcq-q">${q}</p>
    <div class="mcq-opts">${html}</div>
    <div class="mcq-fb ${fbCls} ${saved!==null?'show':''}" id="${id}-fb">${fb}</div>
  </div>`;
}

function refl(id, title, prompt, placeholder) {
  const saved = ls('rf-'+id)||'';
  return `<div class="refl-block">
    <div class="refl-icon">ğŸ¤”</div>
    <div class="refl-title">${title}</div>
    <p>${prompt}</p>
    <textarea class="refl-input" id="rf-${id}" placeholder="${placeholder||'Your reflectionâ€¦'}" onchange="sv('rf-${id}')">${saved}</textarea>
    <div style="margin-top:8px"><button class="btn btn-save" id="sv-rf-${id}" onclick="sv('rf-${id}',true)" style="background:rgba(255,255,255,0.15);color:#fff">ğŸ’¾ Save Reflection</button></div>
  </div>`;
}

function res(icon, title, desc, url) {
  return `<a class="res-card" href="${url}" target="_blank"><span class="res-icon">${icon}</span><div><div class="res-title">${title}</div><div class="res-desc">${desc}</div></div></a>`;
}

function chk(id, label) {
  const checked = ls('chk-'+id)==='1';
  return `<li><input type="checkbox" id="chk-${id}" ${checked?'checked':''} onchange="saveChk('${id}')"/>
    <label id="lbl-${id}" for="chk-${id}" class="${checked?'checked':''}">${label}</label></li>`;
}

function tl(n,week,title,desc){
  return `<div class="tl-item">
    <div class="tl-left"><div class="tl-dot">${n}</div><div class="tl-line"></div></div>
    <div class="tl-body"><div class="tl-week">${week}</div><div class="tl-title">${title}</div><p>${desc}</p></div>
  </div>`;
}

function navBtns(prev, next, unitId) {
  return `<div class="nav-btns">
    ${prev>=0?`<button class="btn btn-ghost" onclick="goTo(${prev})">â† Back</button>`:''}
    <button class="btn btn-complete" onclick="markDone('${unitId}')">âœ“ Mark Complete</button>
    ${next<=9?`<button class="btn btn-primary" onclick="goTo(${next})">Next Unit â†’</button>`:''}
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODULE DATA
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const MODS = [
  /* 0 â€” OVERVIEW */
  { id:'overview', badge:'Welcome', title:'Programme Overview', html: () => `
    <h1 class="mh">MEd Dissertation Unit</h1>
    <p class="lead">Your complete, step-by-step guide from research proposal to final dissertation in Education and Teaching â€” with video lessons, exercises, and AI feedback.</p>
    ${vid('overview')}
    <h2 class="sh">What This Unit Covers</h2>
    <div class="card card-accent">
      <p>Each unit includes a video lesson, explanations, written exercises with <strong>AI supervisor feedback</strong>, reflection activities, MCQ knowledge checks, and curated resources. Your work saves automatically.</p>
    </div>
    <h2 class="sh">Your Dissertation Journey</h2>
    <div>
      ${tl(1,'Weeks 1â€“2','Research Proposal','Define your topic, research questions, rationale and methodology overview.')}
      ${tl(2,'Week 2','Introduction Chapter','Write Chapter 1: background, problem statement, research questions and significance.')}
      ${tl(3,'Weeks 3â€“5','Literature Review','Search, evaluate and synthesise relevant academic literature.')}
      ${tl(4,'Weeks 4â€“5','Research Design','Select and justify your methodology, approach and methods.')}
      ${tl(5,'Week 5','Ethics & Access','Complete ethical clearance and plan participant access.')}
      ${tl(6,'Weeks 6â€“9','Data Collection','Gather data using your chosen instruments and procedures.')}
      ${tl(7,'Weeks 9â€“11','Data Analysis','Analyse and interpret your findings systematically.')}
      ${tl(8,'Weeks 11â€“13','Writing Up','Draft, revise and refine your full dissertation.')}
      ${tl(9,'Week 14','Final Submission','Format, proofread and submit your completed dissertation.')}
    </div>
    <div class="info-box">
      <div class="info-lbl">ğŸ¤– About the AI Features</div>
      <p style="margin:0">Every video has <strong>chaptering</strong> (click any chapter to jump), <strong>auto-pause interactions</strong> (quizzes and reflections that appear at key moments), and an <strong>AI Chat</strong> button so you can interrogate the video content with questions. Written exercises have a <strong>Get AI Feedback</strong> button for supervisor-style feedback on your work. All your responses are recorded and visible below.</p>
    </div>
    <h2 class="sh">Your Video Interaction Data</h2>
    <div class="data-dash" id="data-dash"><p style="color:var(--muted);font-style:italic;font-size:14px">Loading your dataâ€¦</p></div>
    <div class="nav-btns"><button class="btn btn-primary" onclick="goTo(1)">Start Unit 1: Research Proposal â†’</button></div>
  `},

  /* 1 â€” PROPOSAL */
  { id:'proposal', badge:'Unit 1', title:'Writing Your Research Proposal', html: () => `
    <h1 class="mh">Writing Your Research Proposal</h1>
    <p class="lead">Your proposal is the foundation of your dissertation. A strong proposal shows a clear, focused, and feasible research plan.</p>
    ${vid('proposal')}
    <h2 class="sh">What Is a Research Proposal?</h2>
    <p>A research proposal (typically 1,500â€“3,000 words for an MEd) outlines <em>what</em> you will research, <em>why</em> it matters, and <em>how</em> you plan to investigate it. It is a plan and an argument â€” you are convincing your supervisor and institution that your research is worth doing.</p>
    <div class="tip-box"><div class="tip-lbl">ğŸ’¡ Core Questions</div><p style="margin:0">A good proposal answers three things clearly: <strong>What will you study?</strong> <strong>Why does it matter?</strong> <strong>How will you investigate it?</strong></p></div>
    <h2 class="sh">Components of a Strong Proposal</h2>
    <div class="card">
      <h3 class="subh">1. Working Title</h3><p>Specific, focused, indicative of your study. It can evolve â€” this is a working title.</p>
      <h3 class="subh">2. Research Problem & Rationale</h3><p>What gap, issue or tension in educational practice or policy motivates this study?</p>
      <h3 class="subh">3. Research Questions</h3><p>1â€“3 focused, empirically answerable questions. In education these typically begin "Howâ€¦", "Whatâ€¦" or "To what extentâ€¦"</p>
      <h3 class="subh">4. Brief Literature Context</h3><p>2â€“3 paragraphs showing you understand the existing conversation â€” enough to show the gap, not a full review yet.</p>
      <h3 class="subh">5. Methodology Overview</h3><p>What broad approach (qualitative, quantitative, mixed)? What methods (interviews, surveys, observations)? Why?</p>
      <h3 class="subh">6. Significance</h3><p>Who benefits? What contribution does this make to education?</p>
    </div>
    <h2 class="sh">Exercise 1.1 â€” Your Research Topic</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 1.1</span><span class="ex-title">Topic Exploration</span></div>
      ${ex('e1_1a','What educational problem or question genuinely interests you, and why?','Think about your teaching practice, policy issues you have encountered, or challenges you want to understand better.',true,'MEd Education â€” Exercise 1.1: Writing a research problem statement and rationale. Student should identify a specific educational problem, explain its significance, and show why it deserves investigation.',130)}
      ${ex('e1_1b','Who would benefit from research on this topic?','Consider: teachers, students, school leaders, policy makers, curriculum developers.',false,'')}
    </div>
    <h2 class="sh">Exercise 1.2 â€” Crafting Research Questions</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 1.2</span><span class="ex-title">Research Question Development</span></div>
      <div class="info-box"><div class="info-lbl">Strong vs Weak Research Questions</div>
        <p><strong>Too broad:</strong> "How does technology affect learning?" â†’ <strong>Better:</strong> "How do primary school teachers in South Africa integrate mobile technology into literacy instruction?"</p>
        <p style="margin:0"><strong>Yes/No question:</strong> "Does CPD improve teaching?" â†’ <strong>Better:</strong> "To what extent does sustained professional development influence teachers' classroom practice in under-resourced schools?"</p>
      </div>
      ${ex('e1_2a','Write your main research question:','It should be specific, focused, and answerable through research.',true,'MEd Education â€” Exercise 1.2: Writing research questions. Assess whether the question is focused, empirically answerable, appropriately scoped for a Masters dissertation, and uses appropriate research language (How, What, To what extent). Flag if it is too broad, too narrow, or answerable with a yes/no.',120)}
      ${ex('e1_2b','Write 1â€“2 sub-questions that support your main question:','Sub-questions should break the main question into answerable components.',false,'')}
    </div>
    ${mcq('m1','Which characteristic is MOST important in a research question?',['It should be broad enough to cover many aspects','It should be answerable through empirical investigation','It should be interesting to the researcher personally','It should address a gap in funding'],1,'âœ… Correct. Research questions must be empirically answerable â€” that is, they can be investigated through systematic data collection and analysis. Personal interest matters, but answerability is the critical criterion.')}
    ${refl('p1','Your Research Identity','Before continuing, reflect on what draws you to your chosen topic. What experiences from your practice inform this? What assumptions might you bring?','Write your reflection here â€” this is private and for your own development.')}
    <h2 class="sh">Resources</h2>
    <div class="res-grid">
      ${res('ğŸ“–','Punch â€” Developing Effective Research Proposals','Punch, K. (2016). Sage Publications â€” the standard reference.','https://uk.sagepub.com/en-gb/eur/developing-effective-research-proposals/book243516')}
      ${res('ğŸ“','Grad Coach: Research Questions','The "Golden Thread" â€” aims, objectives and research questions explained.','https://gradcoach.com/research-aims-objectives-questions/')}
      ${res('ğŸ”—','APA 7th Edition Guide','Complete APA referencing guide for education research.','https://apastyle.apa.org')}
      ${res('ğŸ“„','ERIC Database','Education-specific academic database â€” best starting point for literature.','https://eric.ed.gov')}
    </div>
    ${navBtns(-1,2,'proposal')}
  `},

  /* 2 â€” INTRODUCTION CHAPTER */
  { id:'introduction', badge:'Unit 2', title:'Writing Your Introduction Chapter', html: () => `
    <h1 class="mh">Writing Your Introduction Chapter</h1>
    <p class="lead">The introduction is your dissertation's opening argument â€” it frames your entire study, establishes why your research matters, and guides the reader through what is to come.</p>
    ${vid('introduction')}
    <h2 class="sh">The Purpose of the Introduction Chapter</h2>
    <p>Chapter 1 (the Introduction) is typically written after your proposal is approved, but it is often substantially revised last â€” once you know exactly what your study found. Its job is to move the reader from the broad context of your field to the specific focus of your study, arriving at your research questions with a clear sense of why they matter.</p>
    <div class="tip-box"><div class="tip-lbl">ğŸ’¡ The Funnel Structure</div><p style="margin:0">Think of the Introduction as a funnel: begin broad (educational landscape, policy context), narrow to the specific problem or gap, then arrive at your research questions. Each paragraph should move the reader closer to your study.</p></div>
    <h2 class="sh">What a Strong Introduction Must Achieve</h2>
    <div class="card">
      <h3 class="subh">1. Background & Context</h3>
      <p>Establish the broad educational, social or policy landscape your study sits within. What is the state of the field? Why does this moment in education matter? Draw on literature to contextualise, but keep this section focused â€” you are not yet reviewing literature in depth.</p>
      <h3 class="subh">2. The Research Problem</h3>
      <p>Identify the specific problem, gap, tension or issue your study addresses. Be precise â€” not "education has many challenges" but "despite significant investment in professional development, teacher practice in X remains under-researched in Y context." Your problem statement is the hinge of the whole chapter.</p>
      <h3 class="subh">3. Research Questions</h3>
      <p>State your research questions clearly. Some introductions present them here; others present aims and objectives first. Check your institution's requirements. Either way, they must be stated explicitly and the reader must understand why these specific questions are worth answering.</p>
      <h3 class="subh">4. Significance & Rationale</h3>
      <p>Argue for your study. Who benefits from this research? What gap in knowledge does it address? What practical, policy or theoretical contribution does it make? This must be substantiated â€” not asserted.</p>
      <h3 class="subh">5. Research Approach (Brief)</h3>
      <p>Provide a brief overview of your methodology â€” qualitative, case study, interpretive, for example. One paragraph. The detail comes in Chapter 3.</p>
      <h3 class="subh">6. Dissertation Overview / Chapter Outline</h3>
      <p>End with a signpost paragraph summarising what each subsequent chapter covers. This is often formulaic but essential â€” it orients the reader and signals academic organisation.</p>
    </div>
    <h2 class="sh">Common Introduction Mistakes</h2>
    <div class="warn-box">
      <p><strong>Too broad at the start:</strong> "Education is important to societyâ€¦" â€” start closer to your specific context.</p>
      <p><strong>Problem statement is vague:</strong> "Not much has been written about thisâ€¦" â€” be specific about what is missing and why it matters.</p>
      <p><strong>Research questions only appear late:</strong> State them clearly and early â€” do not make the reader search for them.</p>
      <p style="margin:0"><strong>Significance is assumed, not argued:</strong> Every claim about importance must be backed with evidence or reasoning.</p>
    </div>
    <h2 class="sh">Exercise 2.1 â€” Your Research Problem Statement</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 2.1</span><span class="ex-title">Writing a Problem Statement</span></div>
      <div class="info-box"><div class="info-lbl">Model Structure</div>
        <p style="margin:0"><em>Despite [what is known / what exists], [the specific problem or gap remains]. This matters because [consequence / significance]. This study therefore investigates [your research focus].</em></p>
      </div>
      ${ex('e2_1ps','Write a focused research problem statement for your dissertation (3â€“5 sentences):','Use the model structure above as a guide. Your statement should identify what is known, what is missing or problematic, and why it matters.',true,'MEd Education â€” Exercise 2.1: Writing a research problem statement for the Introduction chapter. This should clearly identify a specific gap, tension or unresolved issue in the educational context, explain why it is significant, and point towards the need for the proposed study. Assess: Is the problem specific and clearly stated? Is the significance substantiated rather than just asserted? Does it connect logically to the research questions? Is the language appropriately academic? Flag vague claims, unsupported assertions about significance, or problems that are too broad.',130)}
    </div>
    <h2 class="sh">Exercise 2.2 â€” Context and Background Paragraph</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 2.2</span><span class="ex-title">Opening Context Paragraph</span></div>
      <p class="ex-hint">This paragraph sets the scene. It is broad â€” your educational landscape, policy context, or disciplinary background â€” but should immediately begin moving towards your research problem.</p>
      ${ex('e2_2ctx','Write your opening context paragraph for the Introduction chapter (150â€“200 words):','Start with the broad educational, policy or disciplinary context â€” then narrow towards your specific problem by the end of the paragraph.',true,'MEd Education â€” Exercise 2.2: Writing the opening context paragraph of the Introduction chapter. Assess: Does the paragraph begin at an appropriate level of breadth (not too generic, not immediately too narrow)? Does it move logically towards the research problem? Are claims about the educational context supported by evidence or reference to policy/literature? Is the academic voice appropriate for a Masters dissertation? Flag: opening sentences that are too generic ("Education is important..."), unsupported sweeping claims, abrupt transitions, or paragraphs that fail to narrow towards the research focus.',140)}
    </div>
    <h2 class="sh">Exercise 2.3 â€” Chapter Outline Signpost</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 2.3</span><span class="ex-title">Writing Your Chapter Overview</span></div>
      <div class="tip-box"><div class="tip-lbl">Example Language</div>
        <p style="margin:0"><em>"Chapter Two presents a critical review of the literatureâ€¦ Chapter Three details the qualitative methodology adoptedâ€¦ Chapter Four presents the findingsâ€¦ Chapter Five discusses these findings in relation to the theoretical frameworkâ€¦ The dissertation concludes in Chapter Six withâ€¦"</em></p>
      </div>
      ${ex('e2_3outline','Draft the chapter outline paragraph for the end of your Introduction:','Cover each chapter briefly â€” one sentence per chapter. Make it functional and precise, not vague.',false,'')}
    </div>
    ${mcq('mintro','Which element belongs in the Introduction chapter rather than the Literature Review?',['A synthesis of existing theories and frameworks','A critical analysis of methodological approaches in the field','The research problem statement and rationale for the study','A thematic organisation of empirical literature'],2,'âœ… Correct. The research problem statement and rationale belong in the Introduction â€” they set up why the study is needed. The Literature Review then builds the scholarly context in depth. A common mistake is to front-load the Introduction with literature detail that properly belongs in Chapter 2.')}
    ${refl('intro','Your Introduction as Argument','Your introduction is not just a preamble â€” it is an argument for why your research deserves to exist.','Reflect: What is the core argument you are making in your Introduction? If a reader only read Chapter 1, what would they understand about your study and why it matters?')}
    <h2 class="sh">Resources</h2>
    <div class="res-grid">
      ${res('ğŸ“','Grad Coach: Introduction Chapter','How to write the dissertation introduction chapter.','https://gradcoach.com/introduction-chapter/')}
      ${res('âœï¸','Academic Phrasebank â€” Introductions','Manchester University phrases for academic introductions.','https://www.phrasebank.manchester.ac.uk/introducing-work/')}
      ${res('ğŸ“–','Creswell â€” Problem Statements','Research Design Ch. 3: Writing the statement of the problem.','https://scholar.google.com')}
      ${res('ğŸ”','APA 7 Guide','Referencing guide for in-text citations in your introduction.','https://apastyle.apa.org')}
    </div>
    ${navBtns(1,3,'introduction')}
  `},

  /* 3 â€” LIT REVIEW */
  { id:'litreview', badge:'Unit 3', title:'Conducting Your Literature Review', html: () => `
    <h1 class="mh">Conducting Your Literature Review</h1>
    <p class="lead">The literature review is not a summary of what others have written â€” it is a critical, synthesised argument that situates your research within the existing scholarly conversation.</p>
    ${vid('litreview')}
    <h2 class="sh">Purpose of the Literature Review</h2>
    <p>Your literature review demonstrates you understand the scholarly conversation around your topic, identifies what is known and unknown, and justifies your research by showing the gap your study addresses.</p>
    <div class="warn-box"><strong>âš ï¸ Common Mistake:</strong> Many students write literature reviews as annotated bibliographies â€” describing each source in turn. A strong review synthesises sources thematically and builds an argument.</div>
    <h2 class="sh">Your Search Strategy</h2>
    <div class="card">
      <h3 class="subh">Step 1 â€” Identify Key Concepts</h3><p>Break your research question into core concepts. For each, identify synonyms and related terms.</p>
      <h3 class="subh">Step 2 â€” Search Academic Databases</h3><p>Use ERIC (education-specific), Google Scholar, JSTOR, EBSCO. Combine terms with Boolean operators (AND, OR, NOT).</p>
      <h3 class="subh">Step 3 â€” Screen and Select</h3><p>Set criteria: publication date range (last 10 years unless seminal works), peer-reviewed, relevant to your context.</p>
      <h3 class="subh">Step 4 â€” Read Critically</h3><p>Evaluate methodology, sample sizes, context, and limitations â€” not just content.</p>
    </div>
    <h2 class="sh">Exercise 2.1 â€” Search Terms</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 2.1</span><span class="ex-title">Search Term Development</span></div>
      ${ex('e2_1a','List your 3 main concepts from your research question (one per line):','These are the core ideas in your research question.',false,'')}
      ${ex('e2_1b','For each concept, list 3â€“4 synonyms or related terms:','These expand your search and find more relevant literature.',false,'')}
      ${ex('e2_1c','Write a Boolean search string combining your terms:','e.g. "inclusive education" AND "primary school" AND ("teacher beliefs" OR "teacher attitudes")',false,'')}
    </div>
    <h2 class="sh">Exercise 2.2 â€” Writing a Synthesis Paragraph</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 2.2</span><span class="ex-title">Synthesis Practice</span></div>
      <div class="info-box"><div class="info-lbl">Model Synthesis Structure</div>
        <p style="margin:0"><em>Topic sentence (your claim) â†’ Evidence from Source A â†’ Evidence from Source B (agrees/extends/contrasts) â†’ Evidence from Source C â†’ Analytical sentence linking back to your study.</em></p>
      </div>
      ${ex('e2_2','Choose one theme from your literature. Write a synthesis paragraph (150â€“200 words) integrating at least 3 sources around that theme:','This is the core skill of the literature review â€” integrating, not just describing.',true,'MEd Education â€” Exercise 2.2: Writing a literature synthesis paragraph. Assess whether the student has synthesised sources (not just described them one by one), whether they have made a claim and used evidence to support it, whether sources are integrated around ideas rather than listed separately, and whether the writing connects back to the research study.',140)}
    </div>
    ${mcq('m2','What is the PRIMARY purpose of a literature review?',['To demonstrate how many sources you have read','To summarise every article you found','To critically position your research within the existing scholarly conversation','To show your topic has not been researched before'],2,'âœ… Correct. The literature review positions your study â€” showing what is known, what is debated, and where your research contributes. It is a critical synthesis that builds an argument, not a list or summary.')}
    ${refl('lr','Reflection: Gaps and Positioning','After your initial reading, what does the literature say clearly? Where are the debates? Where is your study positioned in relation to what you have read?','Your reflection on gaps and positioning in the literature:')}
    <h2 class="sh">Resources</h2>
    <div class="res-grid">
      ${res('ğŸ”','ERIC Database','Education-specific academic database â€” best first stop.','https://eric.ed.gov')}
      ${res('ğŸ“','Google Scholar','Broad academic search with citation tracking.','https://scholar.google.com')}
      ${res('ğŸ“–','Booth et al. â€” Systematic Literature Reviews','Booth, A. et al. (2016). Systematic Approaches. Sage.','https://uk.sagepub.com/en-gb/eur/systematic-approaches-to-a-successful-literature-review/book244502')}
      ${res('ğŸ—ºï¸','Grad Coach: Lit Review Guide','Step-by-step walkthrough of the literature review process.','https://gradcoach.com/what-is-a-literature-review/')}
    </div>
    ${navBtns(2,4,'litreview')}
  `},

  /* 4 â€” METHODOLOGY */
  { id:'methodology', badge:'Unit 4', title:'Research Design & Methodology', html: () => `
    <h1 class="mh">Research Design & Methodology</h1>
    <p class="lead">Methodology is not just the methods you use â€” it is a coherent philosophical and practical framework that justifies every research decision you make.</p>
    ${vid('methodology')}
    <h2 class="sh">Research Paradigms</h2>
    <div class="card">
      <h3 class="subh">Interpretivism (most common in MEd)</h3><p>Reality is socially constructed. Meaning must be interpreted from participants' perspectives. Leads to qualitative methods â€” interviews, observations, document analysis.</p>
      <h3 class="subh">Positivism</h3><p>Objective, measurable reality. Leads to quantitative methods â€” surveys, tests, statistical analysis.</p>
      <h3 class="subh">Critical/Transformative</h3><p>Aims to critique and transform social structures. Common in studies examining inequality, race, gender and power in education.</p>
    </div>
    <h2 class="sh">Research Designs for Education</h2>
    <div class="res-grid">
      ${res('ğŸ”¬','Case Study','In-depth study of a bounded system â€” a school, classroom or programme. Most common in MEd.','#')}
      ${res('ğŸ“Š','Survey Research','Collects data from larger groups. Good for prevalence and patterns.','#')}
      ${res('ğŸ”„','Action Research','Practitioner-led cycles of inquiry and improvement. Powerful for teacher-researchers.','#')}
      ${res('ğŸ‘ï¸','Ethnography','Immersive observation of a cultural setting. Rich but time-intensive.','#')}
    </div>
    <h2 class="sh">Exercise 3.1 â€” Justifying Your Methodology</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 3.1</span><span class="ex-title">Methodology Justification</span></div>
      <p class="ex-hint">You must not just describe your methodology â€” you must justify it. Use the prompts below to build your argument.</p>
      ${ex('e3_1a','What paradigm underpins your study and why is it appropriate for your research question?','e.g. "My study adopts an interpretivist paradigm because I am seeking to understand teacher experience, which requires exploring meaning and subjectivityâ€¦"',true,'MEd Education â€” Exercise 3.1: Methodology justification. Assess whether the student has correctly identified their research paradigm, explained what it means, and justified why it is appropriate for their specific research question. Look for: philosophical grounding, connection to research question, understanding of qualitative/quantitative distinctions.',130)}
      ${ex('e3_1b','What research approach and specific design will you use, and why?','Justify both the broad approach (qualitative/quantitative/mixed) and the specific design (case study, survey, action research etc.)',true,'MEd Education â€” Exercise 3.1b: Research design justification. Assess whether the student has chosen an appropriate design for their question, justified the choice with reference to the nature of the inquiry, and demonstrated understanding of the design\'s strengths and limitations.',130)}
      ${ex('e3_1c','Describe your planned sample: Who? How many? How selected? Why appropriate?','For qualitative research, size matters less than purposiveness â€” justify why these participants can best illuminate your question.',false,'')}
    </div>
    ${mcq('m3','An MEd student wants to understand how teachers experience a new curriculum policy. Which methodology is MOST appropriate?',['A large-scale survey of 500 teachers','An interpretive case study with semi-structured interviews','A randomised controlled trial comparing two groups','A statistical meta-analysis of existing studies'],1,'âœ… Correct. Understanding teacher experience requires an interpretive approach exploring meaning and context. Semi-structured interviews within a case study allow rich, in-depth exploration of how teachers make sense of policy change.')}
    ${refl('meth','Researcher Positionality','In qualitative research, you are the research instrument. Your background, beliefs and experiences shape what you notice and how you interpret data. This is not a problem â€” but it must be acknowledged.','Write your positionality statement: Who are you in relation to this research? What beliefs do you bring? How might these shape your study?')}
    <h2 class="sh">Resources</h2>
    <div class="res-grid">
      ${res('ğŸ“–','Creswell â€” Research Design','Creswell, J. (2014). Research Design: Qualitative, Quantitative & Mixed Methods. Sage.','https://scholar.google.com')}
      ${res('ğŸ“','Grad Coach: Methodology Chapter','How to write the methodology chapter, with examples.','https://gradcoach.com/how-to-write-the-methodology-chapter/')}
      ${res('ğŸŒ°','Research Onion','Saunders et al. Research Onion framework explained.','https://gradcoach.com/research-onion/')}
      ${res('ğŸ”','Paradigms Guide','Interpretivism, positivism, critical theory explained clearly.','https://gradcoach.com/research-philosophy/')}
    </div>
    ${navBtns(3,5,'methodology')}
  `},

  /* 5 â€” ETHICS */
  { id:'ethics', badge:'Unit 5', title:'Research Ethics & Access', html: () => `
    <h1 class="mh">Research Ethics & Access</h1>
    <p class="lead">Ethical conduct reflects your responsibility to participants, your institution, and the integrity of educational research.</p>
    ${vid('ethics')}
    <h2 class="sh">Core Ethical Principles</h2>
    <div class="card">
      <h3 class="subh">Informed Consent</h3><p>Participants must understand what they agree to â€” purpose, data use, and right to withdraw at any time without consequence.</p>
      <h3 class="subh">Confidentiality & Anonymity</h3><p>Use pseudonyms. Store data securely. Be careful in small communities where anonymity is harder to maintain.</p>
      <h3 class="subh">Voluntary Participation</h3><p>No coercion, direct or indirect. Be mindful of power dynamics â€” a teacher-researcher asking their own students raises ethical concerns.</p>
      <h3 class="subh">Do No Harm</h3><p>Anticipate risks (emotional, professional, social) to participants and mitigate them.</p>
    </div>
    <div class="info-box"><div class="info-lbl">âš¡ Critical Timing</div><p style="margin:0">Ethics approval from your institution's Research Ethics Committee must be received <strong>before</strong> collecting any data. Allow 4â€“6 weeks for this process.</p></div>
    <h2 class="sh">Ethics Checklist</h2>
    <div class="card"><ul class="checklist">
      ${chk('ec1','I have identified all potential ethical risks in my study')}
      ${chk('ec2','I have designed an informed consent form in plain language')}
      ${chk('ec3','If working with minors, I have parent/guardian consent AND child assent forms')}
      ${chk('ec4','I have a plan to maintain confidentiality and anonymity')}
      ${chk('ec5','I have described how data will be stored securely')}
      ${chk('ec6','I have described how participants can withdraw')}
      ${chk('ec7','I have submitted my ethics application')}
      ${chk('ec8','I have written ethics approval before beginning data collection')}
    </ul></div>
    <h2 class="sh">Exercise 4.1 â€” Consent Form Draft</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 4.1</span><span class="ex-title">Writing Your Consent Form</span></div>
      <p class="ex-hint">Your consent form must be written in plain language â€” a participant with a Grade 10 reading level should understand it fully.</p>
      ${ex('e4_1','Draft the key elements of your informed consent form: Study title & purpose | What participation involves | Time required | Risks and benefits | Right to withdraw | Data storage plan | Your contact and supervisor contact','Write as if talking directly to your participant â€” clear, warm, and honest.',true,'MEd Education â€” Exercise 4.1: Informed consent form. Assess whether all required elements are present (purpose, procedures, time, risks/benefits, voluntary withdrawal, data storage, contact details), whether the language is appropriately plain and accessible, and whether there are any ethical concerns in how it is framed.',150)}
    </div>
    ${refl('eth','Reflection: Power and Ethics','Research involves power dynamics â€” between researcher and participant, institution and individual, teacher and student. Where do power imbalances exist in your study? How will you manage them?','Your reflection on power, access, and ethical responsibility:')}
    ${navBtns(4,6,'ethics')}
  `},

  /* 6 â€” DATA COLLECTION */
  { id:'datacollection', badge:'Unit 6', title:'Data Collection', html: () => `
    <h1 class="mh">Data Collection</h1>
    <p class="lead">Data collection is where your research design comes to life. Careful preparation and piloting are essential to ensure quality data.</p>
    ${vid('datacoll')}
    <h2 class="sh">Common Methods in Education Research</h2>
    <div class="card">
      <h3 class="subh">Semi-Structured Interviews</h3><p>Most common in MEd. Open-ended questions with a guide but allows follow-up. 45â€“90 minutes. Record with consent and transcribe.</p>
      <h3 class="subh">Focus Groups</h3><p>Group discussion (4â€“8 participants). Good for exploring shared experiences and social constructions of meaning.</p>
      <h3 class="subh">Observation</h3><p>Structured, semi-structured or unstructured. Can be participant-observer (involved) or non-participant (watching). Use systematic field notes.</p>
      <h3 class="subh">Document Analysis</h3><p>Analyse existing documents: lesson plans, policies, student work, meeting minutes. Use a systematic analysis framework.</p>
    </div>
    <h2 class="sh">Exercise 5.1 â€” Interview Guide</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 5.1</span><span class="ex-title">Interview Guide Development</span></div>
      <div class="tip-box"><div class="tip-lbl">Question Types</div>
        <p style="margin:0"><strong>Opening:</strong> Easy, broad, rapport-building<br/><strong>Core:</strong> Directly address your research questions<br/><strong>Probes:</strong> "Can you tell me more?" / "What do you mean byâ€¦?"<br/><strong>Closing:</strong> Anything to add? Summary check.</p>
      </div>
      ${ex('e5_1a','Write 3 opening questions (broad, non-threatening):','These warm up the participant before the core questions.',false,'')}
      ${ex('e5_1b','Write 4â€“5 core questions directly aligned to your research questions:','These are the heart of your interview â€” each should link to a research question.',true,'MEd Education â€” Exercise 5.1: Interview guide design. Assess whether the questions are open-ended (not yes/no), non-leading, clearly focused on the research questions, appropriately sequenced, and whether they are likely to generate rich data. Flag any questions that are ambiguous, leading, or too broad/narrow.',140)}
    </div>
    ${mcq('m5','A researcher is studying teachers\' experiences of professional development. Which method yields the RICHEST data?',['An anonymous online questionnaire with Likert scales','Semi-structured interviews with 8 purposively selected teachers','A standardised test of teacher knowledge before and after training','An experiment comparing two teacher groups'],1,'âœ… Correct. Semi-structured interviews allow in-depth exploration of experience, meaning and context. They capture nuance and allow follow-up probing that questionnaires cannot â€” ideal for understanding teacher experience.')}
    ${refl('dc','Entering the Field','Data collection is interpersonal and sometimes emotionally complex. Participants share experiences and vulnerabilities. How will you manage the researcher-participant relationship?','Your reflection on entering the research field:')}
    ${navBtns(5,7,'datacollection')}
  `},

  /* 7 â€” ANALYSIS */
  { id:'analysis', badge:'Unit 7', title:'Data Analysis', html: () => `
    <h1 class="mh">Data Analysis</h1>
    <p class="lead">Analysis transforms raw data into findings. It is a rigorous, systematic and iterative process â€” a cycle of engagement with your data, not a single step.</p>
    ${vid('analysis')}
    <h2 class="sh">Thematic Analysis â€” Braun & Clarke</h2>
    <div class="card">
      <p><strong>Phase 1: Familiarisation</strong> â€” Read and re-read transcripts. Note initial ideas.</p>
      <p><strong>Phase 2: Initial coding</strong> â€” Code interesting features of the data systematically.</p>
      <p><strong>Phase 3: Searching for themes</strong> â€” Collate codes into potential themes.</p>
      <p><strong>Phase 4: Reviewing themes</strong> â€” Check themes work in relation to the full dataset.</p>
      <p><strong>Phase 5: Defining and naming themes</strong> â€” Refine, define and name each theme clearly.</p>
      <p><strong>Phase 6: Writing up</strong> â€” Produce a scholarly analysis report with evidence.</p>
    </div>
    <h2 class="sh">Exercise 6.1 â€” Practice Coding</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 6.1</span><span class="ex-title">Data Coding Practice</span></div>
      <div class="info-box"><div class="info-lbl">Interview Extract (fictional)</div>
        <p style="font-style:italic;margin:0">"When they introduced the new curriculum framework, I felt completely overwhelmed. There was one day of training and then we were expected to just implement it. I had 32 students in my class, many of them reading below grade level, and I had no idea how to adapt these new materials for them. I kept thinking, who is this designed for? Not my students. Not my context."</p>
      </div>
      ${ex('e6_1a','List at least 6 initial codes you would apply to this extract:','Think about: what is happening here? What is the participant expressing?',false,'')}
      ${ex('e6_1b','What broader theme(s) do you see emerging from these codes?','Themes are broader patterns â€” usually 2â€“6 words that capture an idea.',false,'')}
    </div>
    <h2 class="sh">Exercise 6.2 â€” Writing a Finding Paragraph</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 6.2</span><span class="ex-title">Findings Write-Up Practice</span></div>
      <div class="tip-box"><div class="tip-lbl">Structure for Each Theme</div>
        <p style="margin:0"><strong>1.</strong> Name and describe the theme<br/><strong>2.</strong> Quote evidence (with pseudonym)<br/><strong>3.</strong> Interpret the evidence<br/><strong>4.</strong> Link to literature</p>
      </div>
      ${ex('e6_2','Draft one finding paragraph: name your theme, provide 1â€“2 illustrative quotations (fictional data is fine), interpret their meaning, and connect to one source from your literature review:','This is the core of your findings chapter â€” practice makes it clearer.',true,'MEd Education â€” Exercise 6.2: Writing a findings paragraph using thematic analysis. Assess whether: a theme is clearly named and described; evidence (quotations) supports the theme; the student interprets the evidence rather than just presenting it; there is an analytical voice connecting to literature or theory; the writing demonstrates the difference between findings and discussion.',150)}
    </div>
    ${mcq('m6','A researcher returns her preliminary themes to participants to check they reflect their experiences. This is called:',['Triangulation','Member checking','Theoretical sampling','Inter-rater reliability'],1,'âœ… Correct. Member checking (respondent validation) involves returning to participants with your interpretations to verify accuracy â€” a key strategy for establishing credibility (trustworthiness) in qualitative research.')}
    ${refl('an','The Analytical Process','Analysis can feel uncertain and messy. You may find your data does not confirm your expectations â€” and that is often where the most interesting insights lie.','What surprised you in your data? What challenges are you encountering? What is emerging that you did not expect?')}
    ${navBtns(6,8,'analysis')}
  `},

  /* 8 â€” WRITING UP */
  { id:'writingup', badge:'Unit 8', title:'Writing Up Your Dissertation', html: () => `
    <h1 class="mh">Writing Up Your Dissertation</h1>
    <p class="lead">Writing is thinking. Start writing early â€” not when you feel "ready". The act of writing forces clarity and reveals what still needs work.</p>
    ${vid('writingup')}
    <h2 class="sh">Standard MEd Structure</h2>
    <div class="card card-accent">
      <p><strong>Ch 1 Introduction</strong> â€” Background, problem, questions, significance (Â±3,000 words)</p>
      <p><strong>Ch 2 Literature Review</strong> â€” Critical synthesis of scholarship (Â±6,000 words)</p>
      <p><strong>Ch 3 Methodology</strong> â€” Design, paradigm, methods, ethics, rigour (Â±4,000 words)</p>
      <p><strong>Ch 4 Findings</strong> â€” Thematic presentation with evidence (Â±6,000 words)</p>
      <p><strong>Ch 5 Discussion</strong> â€” Interpretation in relation to literature and theory (Â±4,000 words)</p>
      <p><strong>Ch 6 Conclusion</strong> â€” Summary, implications, limitations, recommendations (Â±2,000 words)</p>
      <p><strong>References & Appendices</strong></p>
    </div>
    <div class="tip-box"><div class="tip-lbl">ğŸ’¡ Writing Order Tip</div><p style="margin:0">Don't write chapters in order. Many researchers write Ch 3 (methodology) first, then Ch 4 (findings), then Ch 2 (lit review), and Ch 1 last. Write what you know best first to build momentum.</p></div>
    <h2 class="sh">Exercise 7.1 â€” Discussion Paragraph</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 7.1</span><span class="ex-title">Writing Your Discussion</span></div>
      <p class="ex-hint">The discussion is where your researcher voice is strongest. You are answering: <em>So what? What does this mean?</em></p>
      ${ex('e7_1','Take your main finding from Unit 7 (Data Analysis). Write a discussion paragraph that: (a) states the finding, (b) connects to 2+ sources from your literature (agreeing or disagreeing), (c) offers a theoretical interpretation, and (d) states one implication for educational practice:','The discussion links your findings back to the wider scholarly conversation.',true,'MEd Education â€” Exercise 7.1: Writing a discussion paragraph. Assess whether the student: connects findings back to the literature (confirming, extending or challenging it); offers interpretation and analysis rather than just repeating findings; includes theoretical grounding; states a meaningful implication for practice or policy; writes with an authoritative academic voice.',160)}
    </div>
    <h2 class="sh">Exercise 7.2 â€” Conclusion Draft</h2>
    <div class="ex-block">
      <div class="ex-header"><span class="ex-tag">Exercise 7.2</span><span class="ex-title">Writing Your Conclusion</span></div>
      ${ex('e7_2','Draft your conclusion (aim for 300â€“400 words) covering: What did I find? What does it mean? What should change in practice or policy? What are the limits of this study? What should future research investigate?','A strong conclusion is concise, honest about limitations, and forward-looking.',true,'MEd Education â€” Exercise 7.2: Writing a dissertation conclusion. Assess whether all five elements are present (summary of findings, interpretation/meaning, practical/policy implications, honest limitations, future research directions). Also assess: Is the tone appropriately confident but not overstated? Are the limitations specific (not generic apologies)? Is the contribution to knowledge stated clearly?',160)}
    </div>
    ${refl('wu','Your Contribution','Every dissertation, however modest in scope, makes a contribution â€” empirical, methodological, or practical.','Complete this sentence and expand on it: "This study contributes to educational knowledge and practice byâ€¦"')}
    <h2 class="sh">Resources</h2>
    <div class="res-grid">
      ${res('ğŸ“–','Murray â€” How to Write a Thesis','Murray, R. (2017). How to Write a Thesis. Open University Press.','https://scholar.google.com')}
      ${res('ğŸ“','Grad Coach: Discussion Chapter','How to write the discussion chapter with examples.','https://gradcoach.com/discussion-chapter/')}
      ${res('âœï¸','Academic Phrasebank','University of Manchester â€” academic language resource.','https://www.phrasebank.manchester.ac.uk')}
      ${res('ğŸ”—','Grad Coach: Conclusion Chapter','How to write a strong dissertation conclusion.','https://gradcoach.com/conclusion-chapter/')}
    </div>
    ${navBtns(7,9,'writingup')}
  `},

  /* 9 â€” SUBMISSION */
  { id:'submission', badge:'Unit 9', title:'Final Submission Checklist', html: () => `
    <h1 class="mh">Final Submission Checklist</h1>
    <p class="lead">Congratulations on reaching the final stage. Work through this checklist carefully before you submit.</p>
    ${vid('submission')}
    <h2 class="sh">Content Checklist</h2>
    <div class="card"><ul class="checklist">
      ${chk('cc1','Research questions clearly stated and answered by the end')}
      ${chk('cc2','Literature review is thematically organised and critically synthesised')}
      ${chk('cc3','Methodology chapter justifies all research decisions with references')}
      ${chk('cc4','Ethics approval documentation referenced or included in appendix')}
      ${chk('cc5','Findings chapter presents data with direct evidence (quotations/extracts)')}
      ${chk('cc6','Discussion connects findings to literature and theoretical framework')}
      ${chk('cc7','Conclusion addresses implications, limitations and recommendations')}
      ${chk('cc8','All research questions are explicitly answered')}
    </ul></div>
    <h2 class="sh">Format & Presentation</h2>
    <div class="card"><ul class="checklist">
      ${chk('fc1','Title page: title, student number, supervisor, degree, institution, year')}
      ${chk('fc2','Abstract (200â€“300 words): purpose, methodology, key findings, implications')}
      ${chk('fc3','Table of contents with correct page numbers')}
      ${chk('fc4','Consistent font and line spacing throughout')}
      ${chk('fc5','All in-text citations match the reference list')}
      ${chk('fc6','Reference list formatted consistently in APA 7th (or required style)')}
      ${chk('fc7','Appendices labelled and referenced in text')}
      ${chk('fc8','Word count within allowed range')}
    </ul></div>
    <h2 class="sh">Final Quality Check</h2>
    <div class="card"><ul class="checklist">
      ${chk('qc1','Proofread by reading aloud')}
      ${chk('qc2','Similarity/Turnitin check reviewed with supervisor')}
      ${chk('qc3','Supervisor has approved final draft for submission')}
      ${chk('qc4','File saved in required format (PDF)')}
      ${chk('qc5','Digital backup in at least two places')}
      ${chk('qc6','Submission system tested before deadline')}
    </ul></div>
    <div class="card" style="background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 100%);color:#fff;text-align:center;padding:32px;margin-top:24px;">
      <div style="font-size:40px;margin-bottom:12px;">ğŸ“</div>
      <div style="font-family:'Playfair Display',serif;font-size:24px;font-weight:700;margin-bottom:10px;">Well done!</div>
      <p style="color:rgba(255,255,255,0.8);margin:0">You have worked through the complete MEd Dissertation Unit. Your notes and exercises are saved in this browser. Return to any unit at any time to review and update your work.</p>
    </div>
    <div class="nav-btns">
      <button class="btn btn-ghost" onclick="goTo(8)">â† Back to Writing Up</button>
      <button class="btn btn-complete" onclick="markDone('submission');alert('ğŸ‰ Congratulations â€” all units complete!')">ğŸ“ Mark All Complete</button>
    </div>
  `}
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE & STORAGE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let cur = 0;
const done = JSON.parse(localStorage.getItem('diss-done') || '{}');

function ls(k) { try { return localStorage.getItem('diss-' + k); } catch(e) { return null; } }
function lss(k, v) { try { localStorage.setItem('diss-' + k, v); } catch(e) {} }

function sv(id, btn) {
  const el = document.getElementById(id);
  if (!el) return;
  lss(id, el.value);
  if (FB_ON) {
    const u = getSession();
    if (u?.uid && u.role !== 'supervisor' && u.role !== 'lecturer')
      fbUpdate(`studentData/${u.uid}/exercises`, { [id]: { text: el.value, savedAt: new Date().toISOString() } });
  }
  if (btn) {
    const b = document.getElementById('sv-' + id);
    if (b) { b.classList.add('saved'); b.textContent = FB_ON ? 'â˜ Saved' : 'âœ“ Saved'; setTimeout(() => { b.classList.remove('saved'); b.textContent = 'ğŸ’¾ Save'; }, 1800); }
  }
}

function saveChk(id) {
  const el = document.getElementById('chk-' + id);
  const lbl = document.getElementById('lbl-' + id);
  const val = el.checked ? '1' : '0';
  lss('chk-' + id, val);
  if (lbl) lbl.className = el.checked ? 'checked' : '';
  if (FB_ON) { const u = getSession(); if (u?.uid) fbUpdate(`studentData/${u.uid}/checklists`, { [id]: val }); }
}

function pickMcq(id, chosen, correct, fbId) {
  if (ls('mcq-' + id) !== null) return;
  lss('mcq-' + id, String(chosen));
  [0,1,2,3].forEach(i => {
    const el = document.getElementById(`${id}-o${i}`);
    if (!el) return;
    el.classList.add('disabled');
    if (i === correct) el.classList.add('correct');
    else if (i === chosen) el.classList.add('wrong');
  });
  const fb = document.getElementById(fbId);
  if (fb) { fb.classList.add('show', chosen === correct ? 'correct' : 'wrong'); }
}

function markDone(id) {
  done[id] = true;
  localStorage.setItem('diss-done', JSON.stringify(done));
  updateProg();
  document.querySelectorAll('.nav-item').forEach(el => {
    if (el.dataset.id === id) el.classList.add('done');
  });
  if (FB_ON) { const u = getSession(); if (u?.uid) fbUpdate(`studentData/${u.uid}/progress`, { [id]: true }); }
}

function updateProg() {
  const n = Object.keys(done).filter(k => done[k] && k !== 'overview').length;
  const total = MODS.length - 1;
  document.getElementById('prog-fill').style.width = Math.round(n / total * 100) + '%';
  document.getElementById('prog-txt').textContent = `${n} of ${total} units complete`;
}

function goTo(idx) {
  if (_activeIVP) { _activeIVP.destroy(); _activeIVP = null; }
  cur = Math.max(0, Math.min(MODS.length - 1, idx));
  renderCur();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function nextMod() { goTo(cur + 1); }
function prevMod() { goTo(cur - 1); }

function renderCur() {
  const m = MODS[cur];
  const area = document.getElementById('content-area');
  area.innerHTML = m.html();
  document.getElementById('topbar-badge').textContent = m.badge;
  document.getElementById('topbar-title').textContent = m.title;
  document.querySelectorAll('.nav-item').forEach(el => {
    el.classList.toggle('active', el.dataset.idx == cur);
  });
  // Refresh data dashboard when on overview
  if (m.id === 'overview') setTimeout(renderDash, 50);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT â€” called by bootApp() after successful auth
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initApp() {
  const nav = document.getElementById('nav-list');
  MODS.forEach((m, i) => {
    const el = document.createElement('div');
    el.className = 'nav-item' + (done[m.id] ? ' done' : '') + (i === 0 ? ' active' : '');
    el.dataset.idx = i; el.dataset.id = m.id;
    el.innerHTML = `<div class="nav-num">${i === 0 ? 'â˜…' : i}</div><div class="nav-lbl">${m.title}</div>`;
    el.onclick = () => goTo(i);
    nav.appendChild(el);
  });
  renderCur();
  updateProg();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUPERVISOR / LECTURER DASHBOARD
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadSupStudents(user) {
  const list = document.getElementById('sup-stu-list');
  if (!FB_ON) {
    list.innerHTML = `<div class="sup-no-fb" style="padding:12px">
      <div style="font-size:11px;color:rgba(255,255,255,0.3);line-height:1.6">Add your Firebase API key to <code>FB_CONFIG</code> in the source to load students. Students can export CSV individually in the meantime.</div>
    </div>`;
    return;
  }
  list.innerHTML = '<div style="color:rgba(255,255,255,0.25);font-size:12px;padding:6px;font-style:italic">Loadingâ€¦</div>';
  try {
    let students = [];
    if (user.role === 'lecturer') {
      const all = await fbGet('users');
      if (all) students = Object.entries(all).filter(([,p]) => p.role === 'student').map(([uid,p]) => ({uid,...p}));
    } else {
      const mine = await fbGet(`supervisorStudents/${user.uid}`);
      if (mine) students = Object.entries(mine).map(([uid,p]) => ({uid,...p}));
    }
    if (!students.length) {
      list.innerHTML = `<div style="color:rgba(255,255,255,0.3);font-size:12px;padding:8px 6px;line-height:1.55">${user.role==='lecturer'?'No students have registered yet.':'No students assigned yet. Share your username <strong>'+user.username+'</strong> with your students â€” they enter it on the register form.'}</div>`;
      return;
    }
    list.innerHTML = students.map(s => `
      <div class="sup-stu-item" id="sli-${s.uid}" onclick="supLoadStudent('${s.uid}')">
        <div class="sup-stu-name">${s.firstName||''} ${s.lastName||''}</div>
        <div class="sup-stu-meta" id="slm-${s.uid}">${s.studentNum||s.username||s.uid}</div>
        <div class="sup-mini-bar"><div class="sup-mini-fill" id="slb-${s.uid}" style="width:0%"></div></div>
      </div>`).join('');
    students.forEach(async s => {
      const prog = await fbGet(`studentData/${s.uid}/progress`);
      const n = prog ? Object.values(prog).filter(Boolean).length : 0;
      const bar = document.getElementById('slb-'+s.uid);
      const meta = document.getElementById('slm-'+s.uid);
      if (bar) bar.style.width = Math.round(n/9*100)+'%';
      if (meta) meta.textContent = `${s.studentNum||s.username} Â· ${n}/9 units`;
    });
  } catch(e) {
    list.innerHTML = '<div style="color:rgba(255,255,255,0.25);font-size:12px;padding:6px">Error loading students.</div>';
  }
}

async function supLoadStudent(uid) {
  document.querySelectorAll('.sup-stu-item').forEach(el => el.classList.toggle('active', el.id === 'sli-'+uid));
  const main = document.getElementById('sup-main');
  main.innerHTML = '<div style="padding:40px 30px;color:var(--muted);font-size:14px">Loading student dataâ€¦</div>';
  const [profile, data, commentsRaw] = await Promise.all([
    fbGet(`users/${uid}`),
    fbGet(`studentData/${uid}`),
    fbGet(`comments/${uid}`)
  ]);
  if (!profile) { main.innerHTML = '<div style="padding:40px 30px;color:var(--muted)">Student profile not found. The student may not have logged in since Firebase was connected.</div>'; return; }
  supRenderStudent(uid, profile, data||{}, commentsRaw||{});
}

function supRenderStudent(username, p, data, commentsRaw) {
  const main = document.getElementById('sup-main');
  const initials = ((p.firstName||'?')[0] + (p.lastName||'')[0]).toUpperCase();
  const prog = data.progress ? Object.values(data.progress).filter(Boolean).length : 0;
  const exercises = data.exercises || {};
  const videoResps = data.videoResponses ? Object.values(data.videoResponses).reverse() : [];
  const comments = Object.values(commentsRaw).sort((a,b) => b.createdAt > a.createdAt ? 1 : -1);

  const EX_MAP = {
    e1_1:'1.1 â€” Research Questions',  e1_2:'1.2 â€” Research Gap',          e1_3:'1.3 â€” Research Rationale',
    e2_1:'2.1 â€” Problem Statement',   e2_2:'2.2 â€” Opening Context',        e2_3:'2.3 â€” Chapter Outline',
    e3_1:'3.1 â€” Literature Synthesis',e3_2:'3.2 â€” Thematic Argument',
    e4_1:'4.1 â€” Methodology Justification', e4_2:'4.2 â€” Paradigm Explanation',
    e5_1:'5.1 â€” Consent Form Draft',  e5_2:'5.2 â€” Ethical Risk',
    e6_1:'6.1 â€” Interview Guide',     e6_2:'6.2 â€” Participant Rapport',
    e7_1:'7.1 â€” Findings Paragraph',  e7_2:'7.2 â€” Unexpected Finding',
    e8_1:'8.1 â€” Discussion Draft',    e8_2:'8.2 â€” Dissertation Contribution',
    e9_1:'9.1 â€” Submission Reflection'
  };
  const completedEx = Object.keys(exercises).filter(k => exercises[k]?.text).length;

  const exHtml = Object.entries(EX_MAP).map(([id,lbl]) => {
    const ex = exercises[id];
    return `<div class="sup-ex-card">
      <div class="sup-ex-lbl">Exercise ${lbl}</div>
      ${ex?.text
        ? `<div class="sup-ex-text">${ex.text.replace(/</g,'&lt;')}</div>
           <div class="sup-ex-date">Saved ${ex.savedAt ? new Date(ex.savedAt).toLocaleDateString() : ''}</div>`
        : '<div class="sup-ex-empty">Not yet completed</div>'}
    </div>`;
  }).join('');

  const vrHtml = videoResps.length
    ? videoResps.map(r => `<div class="sup-vr-item">
        <span class="sup-vr-tag ${r.type}">${r.type}</span>
        <div>
          <div class="sup-vr-q">${(r.q||'').replace(/</g,'&lt;').slice(0,130)}</div>
          <div class="sup-vr-a">${(r.ans||'').replace(/</g,'&lt;').slice(0,220)}</div>
          ${r.type==='mcq' ? `<div class="sup-vr-result">${r.correct ? '<span style="color:var(--green)">âœ“ Correct</span>' : '<span style="color:var(--red)">âœ— Incorrect</span>'}</div>` : ''}
        </div>
      </div>`).join('')
    : '<div class="sup-ex-empty">No video interactions recorded yet.</div>';

  const cHtml = comments.length
    ? comments.map(c => `<div class="sup-comment">
        <div class="sup-comment-meta">${(c.supervisorName||'Supervisor').replace(/</g,'&lt;')} Â· ${c.createdAt ? new Date(c.createdAt).toLocaleDateString() : ''}</div>
        <div class="sup-comment-text">${(c.text||'').replace(/</g,'&lt;')}</div>
      </div>`).join('')
    : '<div class="sup-ex-empty" style="padding:8px 0">No comments yet â€” add one below.</div>';

  main.innerHTML = `<div class="sup-detail">
    <div class="sup-det-hd">
      <div class="sup-det-av">${initials}</div>
      <div style="flex:1">
        <div class="sup-det-name">${p.firstName||''} ${p.lastName||''}</div>
        <div class="sup-det-meta">${p.username} Â· ${p.studentNum||''} Â· ${p.institution||''} Â· ${p.programme||''} ${p.yearOfStudy?'('+p.yearOfStudy+')':''}</div>
        ${p.researchArea ? `<div class="sup-det-topic">"${p.researchArea.replace(/</g,'&lt;')}"</div>` : ''}
      </div>
      <div style="text-align:right;flex-shrink:0">
        ${profileField('Language', p.language)}
        ${profileField('Email', p.email)}
      </div>
    </div>

    <div class="sup-prog-block">
      <div class="sup-prog-lbl">Progress</div>
      <div class="sup-prog-track"><div class="sup-prog-fill" style="width:${Math.round(prog/9*100)}%"></div></div>
      <div class="sup-prog-nums">${prog} of 9 units complete Â· ${completedEx} of ${Object.keys(EX_MAP).length} exercises saved Â· ${videoResps.length} video interactions</div>
    </div>

    <div class="sup-sh">Written Exercises (${completedEx} / ${Object.keys(EX_MAP).length} completed)</div>
    ${exHtml}

    <div class="sup-sh">Video Interactions (${videoResps.length})</div>
    ${vrHtml}

    <div class="sup-sh">Supervisor Comments (${comments.length})</div>
    <div class="sup-comments-wrap">
      ${cHtml}
      <textarea class="sup-cta" id="cmt-${username}" placeholder="Add a comment or feedback for ${(p.firstName||'this student').replace(/'/g,"\\'")}â€¦"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn btn-complete" style="font-size:13px" onclick="supAddComment('${username}')">ğŸ’¬ Add Comment</button>
        <button class="btn btn-ghost" style="font-size:13px" onclick="supLoadStudent('${username}')">â†º Refresh</button>
      </div>
    </div>
  </div>`;
}

async function supAddComment(studentUid) {
  const ta = document.getElementById('cmt-'+studentUid);
  const text = ta?.value.trim();
  if (!text) { alert('Please write a comment first.'); return; }
  const user = getSession();
  await fbPush(`comments/${studentUid}`, {
    supervisorUsername: user.username,
    supervisorName: `${user.firstName} ${user.lastName}`,
    text, createdAt: new Date().toISOString()
  });
  ta.value = '';
  supLoadStudent(studentUid);
}

async function supAddStudent() {
  const uname = prompt("Enter the student's username:")?.toLowerCase().trim();
  if (!uname) return;
  const user = getSession();
  const uid = await fbGet(`usernames/${uname}`);
  if (!uid) { alert('No user found with that username. The student must register first.'); return; }
  const profile = await fbGet(`users/${uid}`);
  if (!profile) { alert('Student profile not found.'); return; }
  if (profile.role !== 'student') { alert('That account is a supervisor or lecturer, not a student.'); return; }
  await fbSet(`supervisorStudents/${user.uid}/${uid}`, {
    firstName: profile.firstName, lastName: profile.lastName,
    studentNum: profile.studentNum, researchArea: profile.researchArea,
    programme: profile.programme, registeredAt: new Date().toISOString()
  });
  alert(`${profile.firstName} ${profile.lastName} added to your students.`);
  loadSupStudents(user);
}

async function supExportAll() {
  const user = getSession();
  if (!FB_ON) { alert('Firebase not configured.'); return; }
  const path = user.role === 'lecturer' ? 'users' : `supervisorStudents/${user.uid}`;
  const data = await fbGet(path);
  if (!data) { alert('No students found.'); return; }
  const entries = user.role === 'lecturer'
    ? Object.entries(data).filter(([,p]) => p.role==='student').map(([uid,p]) => ({uid,...p}))
    : Object.entries(data).map(([uid,p]) => ({uid,...p}));
  if (!entries.length) { alert('No students found.'); return; }

  const headers = ['Username','First Name','Last Name','Student Number','Institution','Programme','Year','Research Area','Language','Video','Type','Question','Answer','Correct','Video Time (s)','Timestamp'];
  let rows = [headers.join(',')];
  await Promise.all(entries.map(async s => {
    const profile = user.role === 'lecturer' ? s : (await fbGet(`users/${s.uid}`)||s);
    const vr = await fbGet(`studentData/${s.uid}/videoResponses`);
    if (vr) Object.values(vr).forEach(r => rows.push([
      profile.username||'', profile.firstName||'', profile.lastName||'', profile.studentNum||'',
      `"${(profile.institution||'').replace(/"/g,'""')}"`,
      `"${(profile.programme||'').replace(/"/g,'""')}"`,
      `"${(profile.yearOfStudy||'').replace(/"/g,'""')}"`,
      `"${(profile.researchArea||'').replace(/"/g,'""')}"`,
      profile.language||'', r.video||'', r.type||'',
      `"${(r.q||'').replace(/"/g,'""')}"`, `"${(r.ans||'').replace(/"/g,'""')}"`,
      r.correct===null?'n/a':r.correct, r.vt||'', r.ts||''
    ].join(',')));
  }));

  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(rows.join('\n'));
  a.download = 'all-students-' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
}
</script>
</body>
</html>
